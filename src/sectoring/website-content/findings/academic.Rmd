---
title: "OSS in the Academic Sector"
description: "This page focuses on classifying GitHub users into academic institutions."
tags: ["R","text analysis/regex","matching"]
weight: 2
draft: false
output: html_document
---

```{css, echo=FALSE}
/* this chunk of code centers all of the headings */
h1, h2, h3 {
  text-align: center;
}
```

### Approach 

One of the main goals of our summer project is to understand who is producting open-source software (OSS) and important characteristics about them, including which sectors they are embedded within. To classify contributors into the academic sector, we matched GitHub users' email and self-reported affiliation columns to information about universities and colleges from around the world using the [Hipo Labs' university domain list](https://raw.githubusercontent.com/Hipo/university-domains-list/master/world_universities_and_domains.json) - a dataset that has names, countries, and domain names for nearly 9,800 universities across the world. We relied on regular expressions to account for common abbreviations in the self-reported affiliations as well as aliases for specific academic institutions. Having the domain names for academic institutions in the Hipo Labs dataset also helped us match GitHub users to specific universities based on the email address associated with their account. Lastly, we added an additional “Misc. Student" category for GitHub users that reported being students without specific academic institutions. After classifying users into this sector, we used the GitHub commits data to construct networks where nodes represent GitHub users and edges correspond to the number of shared repositories that users can contributed. This page documents this approach and details some of our major findings. 

### Sectoring Results

While the [GHTorrrent](https://ghtorrent.org/) data includes about ~2.1 million GitHub users, only around 20% of those listed provided any organizational affiliation on their profile, leaving us with only around 420,000 individuals to classify total. To start, we just used the Hipo Labs data to classify GitHub users based on their self-reported affiliation information, allocating around __16,000__ users to the academic sector with just this raw string data.  

However, since the input is an free form text field, those who did include affilations had a staggering amount of variation in how they reported that information. We accounted for this in the academic sector by using regular expressions to match common abbreviations and aliases for over 120 academic institutions. For example, anyone whose original self-reported affiliation info was written as "UC San Diego" or "UCSD" was re-categorized into the same group as those included in "University of California, San Diego." This approach boosted our total count to over __27,000__. 

Besides the self-reported affiliation information, we also investigated email addresses as a source of information about users' affiliations. Since the university dataset from Hipo Labs includes domain names, we were able to impute the institutions for an additional __11,000__ users based on their email domain. __In total, we identified 40,273 users in the academic sector.__ Of these, 38,709 are matched to a specific institution while 1,564 are categorized as miscellaneous students. 

```{r packages, message = FALSE, results = FALSE, warning = FALSE, echo=FALSE}
rm(list = ls())

# load packages 
for (pkg in c("tidyverse", "igraph", "visNetwork", "data.table", "R.utils", "DT",
              "RPostgreSQL", "cowplot", "maditr", "stringr", "stringi", "gridExtra")) {library(pkg, character.only = TRUE)}

# connect to postgresql to get our data
conn <- dbConnect(drv = PostgreSQL(), 
                  dbname = "sdad", 
                  host = "10.250.124.195", 
                  port = 5432, 
                  user = Sys.getenv("db_userid"), 
                  password = Sys.getenv("db_pwd"))

# query the users_gh data from github data 
users_gh <- dbGetQuery(conn, "SELECT login, email, company
                              FROM gh.ctrs_extra")

institutions_hipolabs <- dbGetQuery(conn, "SELECT institution, country, domains FROM hipolabs.universities")

# disconnect from postgresql database 
dbDisconnect(conn)

```

```{r clean_hipolabs, message = FALSE, results = FALSE, warning = FALSE, echo=FALSE}
institutions_hipolabs <- institutions_hipolabs %>% 
  as.data.table() %>% 
  # convert to lower case
  dt_mutate(institution = str_to_lower(institution)) %>%
  # remove duplicates
  distinct() %>%
  # add category for students
  add_row(institution = "misc. student") %>%
  # add academic/research organizations present in users_gh but not in hipo labs data
  add_row(institution = "university of tokyo", country = "Japan", domains = "u-tokyo.ac.jp") %>%
  add_row(institution = "aalto university", country = "Finland", domains = "aalto.fi") %>%
  add_row(institution = "international institute of information technology, hyderabad", country = "India", domains = "iiit.ac.in") %>%
  add_row(institution = "space telescope science institute", country = "United States", domains = "stsci.edu") %>%
  add_row(institution = "hasso plattner institute", country = "Germany", domains = "hpi.de") %>%
  add_row(institution = "shanghaitech university", country = "China", domains = "shanghaitech.edu.cn") %>%
  add_row(institution = "university of the philippines", country = "Philippines", domains = "up.edu.ph") %>%
  add_row(institution = "sun yat-sen university", country = "China", domains = "mail2.sysu.edu.cn") %>%
  add_row(institution = "universidade estadual do oeste do paraná", country = "Brazil", domains = "alunos.utfpr.edu.br") %>%
  add_row(institution = "universidad de la laguna", country = "Spain", domains = "ull.edu.es") %>%
  add_row(institution = "universidad del valle", country = "Colombia", domains = "correounivalle.edu.co") %>%
  add_row(institution = "national university of science and technology", country = "Pakistan", domains = "seecs.edu.pk") %>%
  add_row(institution = "universidade federal do rio grande do norte", country = "Brazil", domains = "ufrn.edu.br") %>%
  add_row(institution = "university of toronto", country = "Canada", domains = "cs.toronto.edu") %>%
  add_row(institution = "shiv nadar university", country = "India", domains = "snu.edu.in") %>%
  add_row(institution = "california state university, monterey bay", country = "United States", domains = "csumb.edu") %>%
  add_row(institution = "nazarbayev university", country = "Kazakhstan", domains = "nu.edu.kz") %>% 
  add_row(institution = "turing school", country = "United States", domains = "turing.io") %>%
  add_row(institution = "flatiron school", country = "United States", domains = "flatironschool.com") %>%
  dt_mutate(institution = if_else(institution == "xi'an university of electronic science and technology", "xidian university", institution))
```

```{r}
# implementing daniel's approaches 
legal_entities <- read.csv("/sfs/qumulo/qhome/kb7hp/git/dspg20oss/ossPy/keyFiles/curatedLegalEntitesRaw.csv", header=FALSE)
legal_entities <- legal_entities %>% 
  rename(strings = V1) %>% 
  mutate(strings = as.character(strings))
legal_entities$strings <- substring(legal_entities$strings, 2)
legal_entities$strings <- substr(legal_entities$strings,1, nchar(legal_entities$strings)-1)

symbol_strings <- read.csv("/sfs/qumulo/qhome/kb7hp/git/dspg20oss/ossPy/keyFiles/symbolRemove.csv", header=FALSE)
symbol_strings <- symbol_strings %>% 
  rename(strings = V1) %>% 
  mutate(strings = as.character(strings))
symbol_strings$strings <- substring(symbol_strings$strings, 2)
symbol_strings$strings <- substr(symbol_strings$strings,1, nchar(symbol_strings$strings)-1)
symbol_strings <- symbol_strings %>% slice(-17:-20)

curated_domains <- read.csv("/sfs/qumulo/qhome/kb7hp/git/dspg20oss/ossPy/keyFiles/curatedDomains.csv", header=FALSE)
curated_domains <- curated_domains %>% 
  rename(strings = V1) %>% 
  mutate(strings = as.character(strings))
curated_domains$strings <- substring(curated_domains$strings, 2)
curated_domains$strings <- substr(curated_domains$strings,1, nchar(curated_domains$strings)-1)

users_gh <- users_gh %>% 
  mutate(company_original = company) %>%
  mutate(company = str_replace_all(company, paste(c("(?i)(zqx", na.omit(legal_entities$strings), 
                                                    "zqx|, Inc.)"), collapse = "|"), "")) %>% 
  mutate(company = str_replace_all(company, paste(c("(?i)(zqx", na.omit(symbol_strings$strings), 
                                                    ", $|,$|zqx)"), collapse = "|"), "")) %>%
  mutate(company = str_replace_all(company, paste(c("(?i)(zqx", na.omit(curated_domains$strings), 
                                                    "zqx)"), collapse = "|"), "")) %>%
  mutate(company = tolower(company)); users_gh
```

```{r initial_counts, message = FALSE, results = FALSE, warning = FALSE, echo=FALSE}
length(users_gh$company) 
# 2,143,407 total entries 
# note: there are actually 2,435,698 total users

valid_company_codes <- users_gh %>% drop_na(company) 
length(valid_company_codes$company)
# 422517 users with some company_code information 
length(valid_company_codes$company) / length(users_gh$company)
# putting us at 19.7124% that are identifiable for now 

# organize by company
orgs_initial <- users_gh %>% 
  drop_na(company) %>% 
  dt_mutate(organization = str_to_lower(company)) %>% 
  
  group_by(organization) %>% count() %>% arrange(-n)

# compare with hipo labs dataset
initial_overlap <- semi_join(orgs_initial, institutions_hipolabs, by = c("organization" = "institution"))
sum(initial_overlap[,"n"])
# 16,677 identified users from academic institutions
```

```{r regex_recode, message = FALSE, results = FALSE, warning = FALSE, echo=FALSE}
orgs_clean <- users_gh %>%
  # remove all na's 
  drop_na(company) %>% 
  # convert to lower case 
  dt_mutate(organization = str_to_lower(company)) %>%
  dt_mutate(organization = str_replace_all(organization, "\\b(the )\\b", "")) %>%
  # expand abbreviations "univ." and "iit"
  dt_mutate(organization = str_replace_all(organization, "\\b(?i)(univ\\.|univ|univeristy)\\b", "university")) %>%
  dt_mutate(organization = str_replace_all(organization, "\\b(universitt)\\b", "universität")) %>%
  dt_mutate(organization = str_replace_all(organization, "\\b(mnchen)\\b", "münchen")) %>%
  dt_mutate(organization = str_replace_all(organization, "\\b(politcnica)\\b", "politécnica")) %>%
  dt_mutate(organization = str_replace_all(organization, "\\b(st andrews)\\b", "st. andrews")) %>%
  dt_mutate(organization = str_replace_all(organization, "\\b(iit)\\b", "indian institute of technology,")) %>%
  dt_mutate(organization = str_trim(organization)) %>% 
  # classifying students
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(student)\\b"), 
                              yes = "misc. student", no = organization)) %>%
  # universities and research institutes 
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(duke university|duke|duke university libraries|dukeuniversity)\\b"), 
                              yes = "duke university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
  pattern = "\\b(?i)(stanford university|stanford|stanfordmlgroup|stanfordvl|stanfordgeospatialcenter|stanfordhci|stanfordjournalism|stanfordmsl|stanfordnlp)\\b"), 
                              yes = "stanford university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(massachusetts institute of technology|mit|mitmedialab|mit media lab)\\b"), 
                              yes = "massachusetts institute of technology", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(harvard medical school|harvard|harvard university|harvardagileroboticslab|harvardnlp|harvardx)\\b"), 
                              yes = "harvard university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^princeton university|princeton university$|princetonuniversity|princeton)\\b"), 
                              yes = "princeton university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
  pattern = "\\b(?i)(^columbia university|columbia university$|barnard college|columbia-university)\\b"), 
                              yes = "columbia university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
  pattern = "\\b(?i)(^northeastern university|northeastern university$|northeastern)\\b"), 
                              yes = "northeastern university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
  pattern = "\\b(?i)(^northwestern university|northwestern university$|northwestern)\\b"), 
                              yes = "northwestern university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
  pattern = "\\b(?i)(^cornell university|cornell university$|northwestern|^cornell tech|cornell tech$|cornelltech|^weill cornell|weill cornell$|weill cornell medicine$|cornell|cornell lab of ornithology|cornell-dti|cornell-rpal|cornell asl|weillcornell nygenome|cornell cs|cornell unveristy|cs, cornell)\\b"), 
                              yes = "cornell university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
  pattern = "\\b(?i)(carnegie mellon|carnegie mellon university|carnegie mellon university software engineering institute|carnegie mellon university, silicon valley|cmu)\\b"), 
                              yes = "carnegie mellon university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(john hopkins|john hopkins university|johns hopkins university applied physics laboratory)\\b"), 
                              yes = "john hopkins university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(penn|upenn|pennlabs|university of pennsylvania|the university of pennsylvania|penn medicine)\\b"), 
                              yes = "university of pennsylvania", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
  pattern = "\\b(?i)(university of washington|university of washington(?! state)|univerisity of washington|univeristy of washington|universityofwashington|univesity of washington)\\b"),
                              yes = "university of washington", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization,
                              pattern = "\\b(?i)(university of california, san francisco|uc san francisco|university of california san francisco|ucsf)\\b"),
                              yes = "university of california, san francisco", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization,
                              pattern = "\\b(?i)(uc santa cruz|uc, santa cruz|university of california - santa cruz)\\b"),
                              yes = "university of california, santa cruz", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization,
                              pattern = "\\b(?i)(uc riverside|uc riverside|university of california, riverside$)\\b"),
                              yes = "university of california, riverside", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization,
                              pattern = "\\b(?i)(university of california santa barbara|uc santa barbara|ucsb)\\b"),
                              yes = "university of california, santa barbara", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization,
                              pattern = "\\b(?i)(university of california irvine|university of california, irvine|uc irvine)\\b"),
                              yes = "university of california, irvine", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization,
                              pattern = "\\b(?i)(university of california davis|university of california, davis|uc davis|ucdavis)\\b"),
                              yes = "university of california, davis", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization,
                              pattern = "\\b(?i)(ucla|university of california los angeles|university of california, los angeles)\\b"),
                              yes = "university of california, los angeles", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization,
                              pattern = "\\b(?i)(university of california berkeley|uc berkeley|university of california, berkeley|university of california at berkeley|university of california)\\b"),
                              yes = "university of california, berkeley", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization,
                              pattern = "\\b(?i)(university of california, san diego|university of california san diego|ucsd|uc san diego)\\b"),
                              yes = "university of california, san diego", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^california state|california state$|california state university$|^california polytechnic|california polytechnic$)\\b"), 
                              yes = "california state university system", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^georgia institute of technology|^georgia tech|georgia institute of technology$|georgia tech$)\\b"), 
                              yes = "georgia institute of technology", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of british columbia|ubc)\\b"), 
                              yes = "university of british columbia", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(indiana university|indiana university bloomington|indiana university, bloomington)\\b"), 
                              yes = "indiana university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of texas at austin|university of texas|the university of texas at austin|ut austin)\\b"), 
                              yes = "university of texas at austin", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(cu-boulder|cuboulder)\\b"), 
                              yes = "university of colorado at boulder", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^texas a&m|^texas a & m|texas a&m university)\\b"), 
                              yes = "texas a&m university - college station", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of college london|ucl|university college london)\\b"), 
                              yes = "university college london, university of london", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(new york university|nyu|nyulibraries|nyueserv|itpnyu)\\b"), 
                              yes = "new york university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(penn state|penn state university|pennsylvania state university|the pennsylvania state university|pennstate)\\b"), 
                              yes = "pennsylvania state university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
  pattern = "\\b(?i)(fred hutchinson cancer research center|fredhutch|fred hutch|fred hutchinson|fred hutchinson center|fred hutch cancer research center)\\b"), 
                              yes = "fred hutchinson cancer research center", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(shanghai jiao tong university|sjtu|jiao tong university|jiao tong)\\b"), 
                              yes = "shanghai jiaotong university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^tsinghua|tsinghua$|tsinghua university$|tsinghua univ$|tsinghua unviersity|tsinghuauniversity|tsinghua_university|tsinghuau|national tsing hua university)\\b"), 
                              yes = "tsinghua university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of michigan|university of michigan$|^the university of michigan|university of michigan, ann arbor|univ. of michigan)\\b"), 
                              yes = "university of michigan - ann arbor", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of virginia|university of virginia$|^uva|uva$)\\b"), 
                              yes = "university of virginia, charlottesville", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^virginia tech|virginia tech$|virginia tech university$|^Virginia Polytechnic)\\b"), 
                              yes = "virginia polytechnic institute and state university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of tokyo|^the university of tokyo|university of tokyo$)\\b"), 
                              yes = "university of tokyo", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of waterloo|^the university of waterloo|university of waterloo$)\\b"), 
                              yes = "university of waterloo", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^zhejiang|zhejiang university$|zju)\\b"), 
                              yes = "zhejiang university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of toronto|university of toronto$)\\b"), 
                              yes = "university of toronto", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^imperial college london|imperial college london$|imperial college|imperialcollegelondon)\\b"), 
                              yes = "imperial college london", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of cambridge|university of cambridge$|^cambridge university|cambridge university$)\\b"), 
                              yes = "university of cambridge", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of oxford|university of oxford$|^oxford university|oxford university$|^the university of oxford|^university of oxford,)\\b"), 
                              yes = "university of oxford", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^peking university|peking university$|^peking university,)\\b"), 
                              yes = "peking university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of southern california|university of southern california$|^university of southern california,|usc)\\b"), 
                              yes = "university of southern california", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^nanjing university|^nanjing univ|nanjing university$|^nanjing university,|nju)\\b"), 
                              yes = "nanjing university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of edinburgh|university of edinburgh$|^the university of edinburgh)\\b"), 
                              yes = "university of edinburgh", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^purdue university|^purdue university,|purdue university$|department of statistics,purdue university|purdue univeristy)\\b"), 
                              yes = "purdue university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of florida|^university of florida,|university of florida$|universityofflorida)\\b"), 
                              yes = "university of florida", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of chicago|^university of chicago,|^the university of chicago|university of chicago$|^uchicago|uchicago$|^u of chicago|u of chicago$)\\b"), 
                              yes = "university of chicago", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of illinois at chicago|university of illinois chicago|university of illinois, chicago)\\b"), 
                              yes = "university of illinois at chicago", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of illinois at springfield|university of illinois springfield|university of illinois, springfield)\\b"), 
                              yes = "university of illinois at springfield", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of illinois|university of illinois at urbana-champaign|university of illinois urbana-champaign|university of illinois, urbana-champaign|university of illinois at urbana champaign|uiuc)\\b"), 
                              yes = "university of illinois at urbana-champaign", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^national university of singapore|^national university of singapore,|national university of singapore$)\\b"), 
                              yes = "national university of singapore", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^fudan|fudan university$|fudan university)\\b"), 
                              yes = "fudan university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^boston university|boston university$)\\b"), 
                              yes = "boston university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^arizona state|^arizona state,|arizona state university$|arizona state$)\\b"), 
                              yes = "arizona state university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^mcgill|mcgill university$|mcgill$)\\b"), 
                              yes = "mcgill university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of oregon|university of oregon$)\\b"), 
                              yes = "university of oregon", no = organization)) %>% 
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^oregon state|^oregon state,|oregon state university$|oregon state$)\\b"), 
                              yes = "oregon state university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^stony brook|stony brook university$|stony brook$|^state university of new york)\\b"), 
                              yes = "state university of new york system", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of minnesota|university of minnesota$|^university of minnesota,)\\b"), 
                              yes = "university of minnesota", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(sun yat-sen university|(?=.*sun yat-sen)(?=.*guangzhou).*|sysu|zhongda)\\b"), 
                              yes = "zhongshan university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(nsysu|(?=.*sun yat-sen)(?=.*taiwan).*|national sun yat-sen)\\b"), 
                              yes = "national sun yat-sen university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of alberta|university of alberta$|^university of alberta,)\\b"), 
                              yes = "university of alberta", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of wisconsin-madison|^university of wisconsin|university of wisconsin$|university of wisconsin-madison$|university of wisconsinmadison|^university of wisconsin,|^uw-madison|uw-madison$)\\b"), 
                              yes = "university of wisconsin - madison", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^rwth aachen university|rheinisch westfalische technische hochschule aachen)\\b"), 
                              yes = "rheinisch westfälische technische hochschule aachen", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(politecnico di milano|^polytechnic institute of milan)\\b"),
                              yes = "polytechnic institute of milan", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(delft university of technology|^tu delft)\\b"),
                              yes = "delft university of technology", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(buaa|beihang university)\\b"),
                              yes = "beijing university of aeronautics and astronautics", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(tu dresden|technische universitat dresden)\\b"),
                              yes = "technische universität dresden", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of colorado|university of colorado boulder|university of colorado, boulder|university of colorado - boulder|university of colorado-boulder)\\b"),
                              yes = "university of colorado at boulder", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(katholieke universiteit leuven|ku leuven)\\b"),
                              yes = "katholieke universiteit leuven", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(eth zurich|eidgenössische technische hochschule zürich|eth zürich|swiss federal institute of technology in zurich|politecnico federale di zurigo|école polytechnique fédérale de zurich|eth zrich)\\b"),
                              yes = "ethz - eth zurich", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of maryland|university of maryland$|university of maryland - college park)\\b"),
                              yes = "university of maryland, college park", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(ohio state university|ohio state university$|^ohio state|osu)\\b"),
                              yes = "ohio state university, columbus", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of tsukuba|universityof tsukuba)\\b"),
                              yes = "tsukuba university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university at buffalo|^state university of new york$|^suny$)\\b"),
                              yes = "state university of new york at buffalo", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(technical university of munich|tu munich)\\b"),
                              yes = "technische universität münchen", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of freiburg|albert ludwig university of freiburg|albert-ludwigs-universitt freiburg|uni freiburg|freiburg university|albert ludwig university freiburg|university freiburg|universitt freiburg)\\b"),
                              yes = "albert-ludwigs-universität freiburg", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(washington university in st louis|washington university in st. louis|washington university in saint louis|washington university at st. louis|washington university school of medicine)\\b"),
                              yes = "washington university, saint louis", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)((?<!it )university of copenhagen)\\b"),
                              yes = "copenhagen university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(ghent university|ugent)\\b"),
                              yes = "universiteit gent", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(newcastle university|university of newcastle)\\b"),
                              yes = "university of newcastle-upon-tyne", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(international institute of information technology hyderabad|iiit hyderabad|iiit-hyderabad)\\b"),
                              yes = "international institute of information technology, hyderabad", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(epfl)\\b"),
                              yes = "epfl - epf lausanne", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(uestc)\\b"),
                              yes = "university of electronic science and technology of china", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(bupt)\\b"),
                              yes = "beijing university of posts and telecommunications", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(ustc)\\b"),
                              yes = "university of science and technology of china", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(kaist)\\b"),
                              yes = "korea advanced institute of science & technology", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(epitech)\\b"),
                              yes = "ecole pour l'informatique et les nouvelles technologies", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(mipt)\\b"),
                              yes = "moscow institute of physics and technology", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(hkust)\\b"),
                              yes = "hong kong university of science and technology", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^caltech$|^cal tech$)\\b"),
                              yes = "california institute technology", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(scut)\\b"),
                              yes = "south china university of technology", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(unicamp|university of campinas)\\b"),
                              yes = "universidade estadual de campinas", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(feup)\\b"),
                              yes = "universidade do porto", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(king's college london|king's college|king's college, department of informatics)\\b"),
                              yes = "king's college london, university of london", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(karlsruhe institute of technology)\\b"),
                              yes = "karlsruher institut für technologie", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(nus)\\b"),
                              yes = "national university of singapore", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(ntnu)\\b"),
                              yes = "norwegian university of science and technology", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(tu berlin|technische universitat berlin)\\b"),
                              yes = "technische universität berlin", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(tu darmstadt|technische universitat darmstadt)\\b"),
                              yes = "technische universität darmstadt", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(kth)\\b"),
                              yes = "kth royal institute of technology", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(umass amherst|umass-amherst|umass - amherst|umass-amherst|umass, amherst|university of massachusetts amherst|university of massachusetts, amherst|university of massachusetts)\\b"),
                              yes = "university of massachusetts at amherst", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(pku)\\b"),
                              yes = "peking university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(nc state university|ncsu)\\b"),
                              yes = "north carolina state university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of north carolina|unc chapel hill|unc-chapel hill|university of north carolina, chapel hill|^university of north carolina at chapel|chapel hill$)\\b"),
                              yes = "university of north carolina at chapel hill", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(technische universitt mnchen|tu munchen|tu münchen|tum)\\b"),
                              yes = "technische universität münchen", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(ufmg)\\b"),
                              yes = "universidade federal de minas gerais", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(linkping university|linkoping university)\\b"),
                              yes = "linköping university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of stuttgart)\\b"),
                              yes = "universität stuttgart", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(ecnu)\\b"),
                              yes = "east china normal university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(universidade de brasilia|universidade de braslia)\\b"),
                              yes = "universidade de brasília", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of hawaii)\\b"),
                              yes = "university of hawaii system", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(trinity college dublin)\\b"),
                              yes = "university of dublin, trinity college", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(cuhk)\\b"),
                              yes = "chinese university of hong kong", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(tu wien)\\b"),
                              yes = "technische universität wien", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(bits pilani)\\b"),
                              yes = "birla institute of technology and science", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(lancaster university)\\b"),
                              yes = "university of lancaster", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(saarland university)\\b"),
                              yes = "universität des saarlandes", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(queen mary university of london)\\b"),
                              yes = "queen mary, university of london", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(telkom university)\\b"),
                              yes = "universitas telkom", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of missouri|university of missouri$)\\b"),
                              yes = "university of missouri - columbia", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of nebraska - lincoln|university of nebraska-lincoln|university of nebraska lincoln|university of nebraskalincoln)\\b"),
                              yes = "university of nebraska, lincoln", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of nebraska at omaha|university of nebraska omaha|the university of nebraska at omaha|university of nebraska - omaha|university of nebraska--omaha|university of nebraskaat omaha)\\b"),
                              yes = "university of nebraska, omaha", no = organization)) %>%
  
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(hasso plattner institut|hasso-plattner-institute|hasso-plattner-institut|hasso-plattner institut|hasso plattner institute)\\b"),
                              yes = "hasso plattner institute", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(whu)\\b"),
                              yes = "wissenschaftliche hochschule für unternehmensführung, otto-beisheim hochschule", no = organization)) %>% 
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^federal university of campina grande$|ufcg)\\b"),
                              yes = "universidade federal de campina grande", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(universit catholique de louvain)\\b"),
                              yes = "université catholique de louvain", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^bonn university$|universitt bonn|^university of bonn$)\\b"),
                              yes = "rheinische friedrich-wilhelms universität bonn", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(delhi technological university|^delhi college of engineering|delhi college of engineering$)\\b"),
                              yes = "delhi college of engineering (dce)", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^freie universitt berlin$)\\b"),
                              yes = "freie universität berlin", no = organization)) %>% 
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(universidade federal do cear|federal university of cear)\\b"),
                              yes = "universidade federal do ceará", no = organization)) %>% 
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(politecnico di torino)\\b"),
                              yes = "polytechnic institute of turin", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(ufsc)\\b"),
                              yes = "universidade federal de santa catarina", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(unc charlotte)\\b"),
                              yes = "university of north carolina at charlotte", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(turingschool|^turing school$)\\b"),
                              yes = "turing school", no = organization)) %>%
  dt_mutate(organization = str_replace_all(organization, 
      "\\b(?i)(university of so paulo|university of sao paulo|universidade de so paulo|universidade de sao paulo)\\b", "universidade de são paulo")) %>% 
  dt_mutate(organization = str_replace_all(organization, 
      "\\b(?i)(universit de montral|universit de montral)\\b", "université de montréal"))

# create a frequency table
org_counts <- orgs_clean %>% group_by(organization) %>% count() %>% arrange(-n) 

# compare with hipo labs dataset to pull out academic institutions
institutions_hipolabs <- institutions_hipolabs %>% 
  as.data.table() %>% 
  dt_mutate(institution = str_to_lower(institution))
overlap <- semi_join(org_counts, institutions_hipolabs, by = c("organization" = "institution"))
sum(overlap[,"n"])
sum(filter(overlap, organization != "misc. student")[,"n"])
filter(overlap, organization == "misc. student")$n

# make a table to see what isn't caught by hipo labs
leftover <- anti_join(org_counts, overlap)
```

```{r domains_recode, message = FALSE, results = FALSE, warning = FALSE, echo=FALSE}
# now let's bind everything together 
# first, lets take the orgs_clean and just get the recoded column 
matched_academic_users <- orgs_clean %>% 
  select(login, organization) %>% 
  rename(institution = organization) %>% 
  inner_join(institutions_hipolabs, by = "institution") %>% 
  select(login, institution) %>% 
  distinct(login, institution) %>% 
  mutate(is_academic = 1)
# the current total is at ~29446 users 

# get just the domains from the emails
email_domains <- users_gh %>% 
  drop_na(email) %>%
  dt_mutate(domains = str_replace_all(email, "^[a-zA-Z0-9_.+-]+@", ""))

# match academic institutions from hipolabs to users based on email domains
# only impute company when it was NA
imputed_institutions <- email_domains %>%
  as.data.table() %>%
  inner_join(drop_na(institutions_hipolabs, domains)) %>%
  subset(is.na(company)) %>% 
  select(login, institution) %>% 
  distinct(login, institution) %>%
  mutate(is_academic = 1)

nrow(imputed_institutions)
# 11,645 imputed

# bind first and second recoding iterations  
matched_academic_users <- matched_academic_users %>% 
  bind_rows(imputed_institutions)
# now at 41,091 users 

# bind matched_academic with users_gh with valid emails
all_gh_users <- email_domains %>% 
  select(login, company, email, domains) %>% 
  full_join(matched_academic_users, by = "login") %>% 
  mutate(is_academic = replace_na(is_academic, 0)) %>% 
  mutate(new_institution = replace_na(institution, "tmp_info")) %>% 
  mutate(new_institution = ifelse(test = str_detect(string = new_institution, 
                                  pattern = "tmp_info"),
                                  yes = company, no = new_institution)) %>% 
  select(-institution) %>% rename(institution = new_institution) %>% 
  select(login, company, institution, email, domains, is_academic)

# this finds all the top remaining educational domains (saving this for later - potentially useful)
top_educ_subdomains <- all_gh_users %>% 
  # only those not classified 
  filter(is_academic == 0 & is.na(company) == TRUE) %>% 
  select(-company, -institution, -is_academic) %>% 
  #filter(grepl(".edu", email)) %>% mutate(email_tmp = email) %>% separate(email_tmp, c(NA,"domain"), sep = "\\@") %>% 
  # necessary to remove false positives
  filter(grepl(".edu", domains)) %>% 
  count(domains) %>% 
  arrange(-n)

# second iteration of email classification (extracts domains from concatenated school email domains)
emails_matched_again <- all_gh_users %>% 
  # only those not classified 
  filter(is_academic == 0 & is.na(company) == TRUE) %>% 
  select(-company, -institution, -is_academic) %>% 
  #filter(grepl(".edu", email)) %>% mutate(email_tmp = email) %>% separate(email_tmp, c(NA,"domain"), sep = "\\@") %>% 
  # necessary to remove false positives
  filter(grepl(".edu", domains)) %>%  
  tidyr::extract(domains, into = c("subdomain", "domains"), "^([^.]+)\\.(.*)") %>% 
  inner_join(institutions_hipolabs, by = "domains") %>% 
  mutate(new_academic = 1) %>% 
  transmute(login = login, new_institution = institution, new_academic = new_academic) %>% 
  distinct(login, new_institution, new_academic)
# this added 2844 new users 

# combines it back into full dataset 
all_gh_users <- all_gh_users %>% 
  full_join(emails_matched_again, by = "login") %>% 
  mutate(new_academic = replace_na(new_academic, 0)) %>% 
  mutate(is_academic = is_academic + new_academic) %>% 
  select(-new_academic) %>% 
  mutate(tmp_institution = replace_na(new_institution, "tmp_info")) %>% 
  mutate(tmp_institution = ifelse(test = str_detect(string = tmp_institution, 
                                  pattern = "tmp_info"),
                                  yes = institution, no = tmp_institution)) %>% 
  transmute(login = login, company = company, institution = tmp_institution, 
            email = email, domains = domains, is_academic = is_academic) %>% 
  distinct(login, company, institution, email, domains, is_academic)

# brings total to 43,935
all_gh_users %>% 
  filter(is_academic == 1) %>% 
  distinct(login, company, institution, email, domains, is_academic)
```

```{r}

# STEP 1: MATCH ON UNIVERSITY STRING 
# let's filter out all of the classified academic users and catch any additional mentions of university/college 
custom_university_string <- "university|college|universitet|unibertsitate|univerzitetski|université|universidad|universität|universiteit|università|universidade|universit|universite|school"

misc_academic_users <- all_gh_users %>% 
  filter(is_academic == 0) %>% 
  mutate(new_acad_user = ifelse(test = str_detect(string = institution, 
                              pattern = custom_university_string),
                              yes = 1, no = 0)) %>% 
  mutate(new_acad_user = replace_na(new_acad_user, 0)) %>% 
  filter(new_acad_user == 1) %>% 
  select(login, company, new_acad_user) 
# dataframe of users that mention university/college string (n = 3,498)

# table of the top universities not classified already
# NOTE: we could continue to reiterate using this to make our algorithm more robust 
misc_academic_users %>% 
  filter(new_acad_user == 1) %>% 
  select(company, new_acad_user) %>% 
  count(company) %>% 
  arrange(-n)

# STEP 2: MATCH ON .EDU IN EMAIL 
misc_academic_emails <- all_gh_users %>% 
  filter(is_academic == 0 & is.na(company) == TRUE ) %>% 
  mutate(new_acad_email = ifelse(test = str_detect(string = domains, 
                              pattern = ".edu"),
                              yes = 1, no = 0)) %>% 
  mutate(new_acad_email = replace_na(new_acad_email, 0)) %>% 
  filter(new_acad_email == 1) %>% 
  select(login, domains, new_acad_email)

# table of the top edu emails not classified already
# NOTE: we could continue to reiterate using this to make our algorithm more robust 
misc_academic_emails %>% 
  filter(new_acad_email == 1) %>% 
  select(domains, new_acad_email) %>% 
  count(domains) %>% 
  arrange(-n)
# this added another 968 

# STEP 3: BIND STEPS 1 & 2 TOGETHER 
misc_academic_users_tmp <- misc_academic_users %>% 
  select(-company) %>% 
  rename(new_academic = new_acad_user)
misc_academic_emails_tmp <- misc_academic_emails %>% 
  select(-domains) %>% 
  rename(new_academic = new_acad_email)
misc_academic_comb <- rbind(misc_academic_users_tmp, misc_academic_emails_tmp)
rm(misc_academic_users_tmp, misc_academic_emails_tmp)

# join that back to the original gh data 
all_gh_users <- all_gh_users %>% 
  full_join(misc_academic_comb, by = "login") %>% 
  rename(old_academic = is_academic) %>% 
  mutate(new_academic = replace_na(new_academic, 0)) %>% 
  mutate(is_academic = old_academic + new_academic) %>% 
  select(-old_academic, -new_academic)

# new count is n = 48939 
all_gh_users %>% 
  filter(is_academic == 1) %>% count()

# get counts 
academic_counts_original <- all_gh_users %>% 
  filter(is_academic == 1) %>% 
  select(company, institution, is_academic) %>% 
  mutate(institution = replace_na(institution, "misc. student")) %>% 
  count(institution) %>% 
  arrange(-n) 
  
academic_counts_original

# this process can still be improved within the sector 
# as of sept 14, 2020, the most common errors are: 
## letters with accents getting chopped out (disproportionately non-english)
## foreign universities not being in our database 
## someone could add ^ and # to the regex to make them more inclusive (could catch more false positives)
## someone could embed this into a nested dictionary (as csv) and then convert to a package 
```

```{r}
# rejoin with hipo labs data

# collapse the domains into one row
collapsed_emails <- academic_counts_original %>%
  left_join(institutions_hipolabs, by = "institution") %>% 
  filter(!(institution == "misc. student")) %>%  # remove misc. students for future analyses
  # collapse the domains into one row
  group_by(institution, n) %>% 
  summarise(domains = paste(domains, collapse = ", ")) %>% 
  arrange(-n); collapsed_emails

# break all the countries attached to academic domains  
# then test to see if the country codes attached to those domains 
# 
collapsed_countries <- academic_counts_original %>%
  left_join(institutions_hipolabs, by = "institution") %>% 
  filter(!(institution == "misc. student")) %>%  # remove misc. students for future analyses
  # collapse the domains into one row
  group_by(institution, n) %>% 
  summarise(country = paste(country, collapse = ";")) %>% 
  mutate(all_countries = country) %>% 
  select(institution, n, all_countries, country) %>% 
  separate(country, c("country", "country2", "country3"), ";" ) %>%
  #mutate(test_col1 = ifelse(country1 == country2, TRUE, FALSE)) %>% 
  #mutate(test_col2 = ifelse(country2 == country3, TRUE, FALSE)) %>%
  #arrange(-n) %>% 
  #filter(test_col1 == FALSE | test_col2 == FALSE)
    mutate(country = ifelse(test = str_detect(string = institution, 
         pattern = "\\b(?i)(universidad de los andes)\\b"), yes = "Colombia", no = country)) %>% 
    mutate(country = ifelse(test = str_detect(string = institution, 
         pattern = "\\b(?i)(korea university)\\b"), yes = "Korea, Republic of", no = country)) %>%
    mutate(country = ifelse(test = str_detect(string = institution, 
         pattern = "\\b(?i)(southeast university)\\b"), yes = "China", no = country)) %>%
    mutate(country = ifelse(test = str_detect(string = institution, 
         pattern = "\\b(?i)(western university)\\b"), yes = "Canada", no = country)) %>% 
    mutate(country = ifelse(test = str_detect(string = institution, 
         pattern = "\\b(?i)(universidad simón bolivar)\\b"), yes = "Colombia", no = country)) %>% 
    mutate(country = ifelse(test = str_detect(string = institution, 
         pattern = "\\b(?i)(suleyman demirel university)\\b"), yes = "Turkey", no = country)) %>% 
    mutate(country = ifelse(test = str_detect(string = institution, 
         pattern = "\\b(?i)(aga khan university)\\b"), yes = "Pakistan", no = country)) %>% 
    mutate(country = ifelse(test = str_detect(string = institution, 
         pattern = "\\b(?i)(universidad de córdoba)\\b"), yes = "Spain", no = country)) %>% 
   mutate(country = ifelse(test = str_detect(string = institution, 
         pattern = "\\b(?i)(universidad del pacifico)\\b"), yes = "Peru", no = country)) %>% 
  #select(institution, country) %>% 
  arrange(-n) 
      
academic_counts <- collapsed_countries %>% 
  select(institution, country) %>% 
  full_join(collapsed_emails, by = "institution")

academic_counts %>% 
  filter(country == "NA")
```


```{r get_countries, message = FALSE, results = FALSE, warning = FALSE, echo=FALSE}
academic_counts
sum(academic_counts[,"n"]) 
# larger than before because it's double-counting the institutions that are in multiple countries or have multiple domains

# group together different country and domain values for the same institution
group1 <- academic_counts[duplicated(academic_counts$organization), ] %>% rename(c(country2 = country, domains2 = domains))
group2 <- group1[duplicated(group1$organization), ] %>% rename(c(country3 = country2, domains3 = domains2))
group3 <- group2[duplicated(group2$organization), ] %>% rename(c(country4 = country3, domains4 = domains3))
group4 <- group3[duplicated(group3$organization), ] %>% rename(c(country5 = country4, domains5 = domains4))

# remove duplicates so each group has unique values
group1 <- group1[!duplicated(group1$organization), ]
group2 <- group2[!duplicated(group2$organization), ]
group3 <- group3[!duplicated(group3$organization), ]
group4 <- group4[!duplicated(group4$organization), ]

# add back in the multiple countries/domains, but as additional columns
# now there is only one row for each institution
academic_counts <- academic_counts[!duplicated(academic_counts$organization), ] %>% 
  left_join(group1) %>%
  left_join(group2) %>%
  left_join(group3) %>%
  left_join(group4)

# add NAs for when multiple country listings are the same (if the duplicated institution is from multiple domains)
# or when multiple domain listings are the same (if the duplicated institution is from multiple countries)
academic_counts <- academic_counts %>%
  mutate_all(str_replace_na) %>%
  dt_mutate(country2 = if_else(country == country2, "NA", country2)) %>%
  dt_mutate(country3 = if_else(country == country3, "NA", country3)) %>%
  dt_mutate(domains2 = if_else(domains == domains2, "NA", domains2)) %>%
  dt_mutate(domains3 = if_else(domains == domains3, "NA", domains3)) %>%
  dt_mutate(domains4 = if_else(domains == domains4, "NA", domains4)) %>%
  dt_mutate(domains5 = if_else(domains == domains5, "NA", domains5))

# collapse into single columns for country/domains
# we want to avoid having multiple countries for an institution, since they'd be double-counted in the following analyses
# for the 21 institutions represented that are in multiple countries, the primary country is manually coded
academic_counts <- academic_counts %>%
  dt_mutate(country = if_else(condition = institution %chin% c("universidad simón bolivar", 
                                                                "suleyman demirel university", 
                                                                "universidad de córdoba", 
                                                                "aga khan university", 
                                                                "southeast university", 
                                                                "universidad de los andes", 
                                                                "korea university"), true = country2, false = country)) %>%
  dt_mutate(domains_combined = str_c(domains, domains2, domains3, domains4, domains5, sep = ", ")) %>%
  transmute(institution = institution, n = n, country = country, domains = domains_combined)

# remove remaining NAs
academic_counts <- academic_counts %>% 
  dt_mutate(domains = str_replace_all(domains, ", NA", "")) %>%
  dt_mutate(n = as.numeric(n)) # for some reason n got changed to chr type
```




```{r, message = FALSE, results = FALSE, warning = FALSE, echo=FALSE}
# connect to postgresql to get data (in rivanna)
#conn <- dbConnect(drv = PostgreSQL(), 
# dbname = "sdad", 
# host = "10.250.124.195", 
# port = 5432, 
# user = Sys.getenv("db_userid"), 
# password = Sys.getenv("db_pwd"))
#dbWriteTable(conn, c("gh", "sna_ctr_academic"), final_table)
# disconnect from postgresql database 
#dbDisconnect(conn)
```

```{r stats, message = FALSE, results=FALSE, warning = FALSE, echo=FALSE}
length(filter(academic_counts, country == "United States")$organization) / length(academic_counts$organization)
# 33% of academic institutions represented are in the U.S. -> after DSPG 
# 14% of academic institutions represented are in the U.S. -> after Brandon's recoding in Sept
sum(filter(academic_counts, country == "United States")[, "n"]) / sum(academic_counts[, "n"])
# 55% of users in the academic sector are at U.S. institutions -> after DSPG 
# 50% of users in the academic sector are at U.S. institutions -> after Brandon's recoding in Sept 
sum(academic_counts[,"n"]) / length(users_gh$login) 
# 0.02% of all users have been matched to an academic institution

# look at percentage of academic sector users in each country
options(scipen = 10)
country_user_percentages <- academic_counts %>% 
  group_by(country) %>% 
  select(country, n) %>% 
  summarise(n = sum(n), percentage = sum(n) / sum(academic_counts[, "n"])) %>% 
  mutate(percentage = paste0(100 * round(percentage, 5), "%")) %>% 
  arrange(-n)
```

```{r, top_ten, fig.width=12, echo=FALSE, include=FALSE}
academic_counts_sorted_top10 <- academic_counts %>% 
  drop_na(country) %>% 
  slice_max(n, n = 10) %>% 
  arrange(n) %>%
  dt_mutate(organization = factor(organization, levels = organization))

academic_counts_sorted_top20 <- academic_counts %>% 
  drop_na(country) %>% 
  slice_max(n, n = 20) %>% 
  arrange(n) %>%
  dt_mutate(organization = factor(organization, levels = organization))

ggplot(data = academic_counts_sorted_top10) + 
  geom_col(mapping = aes(organization, n, fill = n)) + 
  labs(x = "Academic institution", 
       y = "User count", 
       title = "Top 10 universities by users") + 
  coord_flip() +
  theme_minimal()
```

### Top OSS Countries in the Academic Sector 

Generally, we found that users based in the United States are most prominently represented. Roughly one-third of the institutions represented in our data are from the US, and users from those institutions make up around 55 percent of total users in the academic sector. In this figure, you can see the locations with the greatest number of GitHub users in the academic sector (plotted on a logarithmic scale). Below the figure is a searchable table of countries, which includes the raw number of users at academic institutions in that country (n) as well as the percentage of users at academic institutions in that country compared to the rest of the world.

```{r, countries_users, fig.height = 9, fig.width = 12, warning = FALSE, echo=FALSE}
#country_frequency_institutions <- academic_counts %>% group_by(country) %>% count(wt = n(), sort = TRUE)

country_frequency_users <- academic_counts %>% 
  drop_na(country) %>% 
  mutate(country = tolower(country)) %>% 
  dt_mutate(country = str_replace_all(country, "korea, republic of", "south korea")) %>%
  dt_mutate(country = str_replace_all(country, "russian federation", "russia")) %>%
  group_by(country) %>% 
  count(sort = TRUE, wt = n)
country_users_sorted <- country_frequency_users %>%
  arrange(n) %>%
  dt_mutate(country = factor(country, levels = country))

continent <- c("united states" = "north america",
               "china" = "asia",
               "united kingdom" = "europe",
               "canada" = "north america",
               "germany" = "europe",
               "india" = "asia",
               "japan" = "asia",
               "brazil" = "south america",
               "south korea" = "asia",
               "switzerland" = "europe",
               "australia" = "australia",
               
               "netherlands" = "europe",
               "sweden" = "europe",
               "france" = "europe",
               "colombia" = "south america",
               "spain" = "europe",
               "singapore" = "asia",
               "russia" = "europe",
               "taiwan" = "asia",
               "italy" = "europe",
               "hong kong" = "asia") %>% rev()

ggplot(country_users_sorted[(.N-20):.N, ], aes(color = continent)) +
  geom_point(aes(x = country, y = n), size = 4) +
  geom_segment(data = country_users_sorted[(.N-20):.N, ], mapping = aes(x = country, xend = country, y = 0, yend = n), size = 1) +
  #scale_color_manual(values = c("asia" = "#E57200", "australia" = "#375758", "europe" = "#485C99", "north america" = "#12B2CE", "south america" = "#D7E029")) +
  theme_minimal() +
  labs(x = "Country", y = "Number of Users", title = "Top-20 Countries by Users in Academic Sector") +
  theme(plot.title = element_text(size=23, hjust = 0.5),
        axis.title =element_text(size=18),
        axis.title.y =element_blank(),
        axis.text = element_text(size = 18),
        legend.title=element_text(size=18, hjust = 0.5, face="bold"),
        legend.text=element_text(size=18),
        legend.position = c(.9, .1),
        legend.justification = c("right", "bottom"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6),
        legend.background = element_rect(fill="white",
                                  size=0.5, linetype="solid", 
                                  colour ="black")) +
  scale_y_log10() +
  coord_flip() +
  scale_color_manual(labels=c("asia",  "australia", "europe", "north america","south america"),
                     values=c("#232D4B", "#99BDAD",  "#E57200", "#0E879C", "#D9E12B")) 
```
```{r country_percentage_table, message = FALSE,  warning = FALSE, echo=FALSE}
datatable(country_user_percentages)
```

### Top OSS Universities Around the World

This figure shows which specific academic institutions had the greatest number of GitHub users contributing to OSS. The top 10 are all located in the US, though both China and Canada also have universities with a high number of contributors. Below the figure is another searchable table, this time of academic institutions.

```{r, by_country, fig.height = 9, fig.width=12, warning = FALSE,  echo=FALSE, message=FALSE}
# rename top universities to make labels shorter
top_universities <- select(academic_counts_sorted, organization) %>%
  add_column(shorter = c("Peking University",
                         "Tsinghua University",
                         "University of Waterloo",
                         "Harvard University",
                         "UC San Diego",
                         "Duke University",
                         "Shanghai Jiao Tong Univ.",
                         "Zhejiang University",
                         "Georgia Tech",
                         "University of Texas",
                         "Columbia University",
                         "University of Illinois",
                         "University of Michigan",
                         "New York University",
                         "Carnegie Mellon University",
                         "University of Washington",
                         "Cornell University",
                         "Univ. of Southern California",
                         "Stanford University",
                         "MIT",
                         "UC Berkeley")) %>%
  inner_join(academic_counts_sorted) %>%
  arrange(n) %>%
  dt_mutate(shorter = factor(shorter, levels = shorter))


ggplot(top_universities, aes(color = country)) +
  geom_point(aes(x = shorter, y = n), size = 4) +
  geom_segment(data = top_universities, mapping = aes(x = shorter, xend = shorter, y = 0, yend = n), size = 1) +
  scale_color_manual(labels = c("Canada", "China", "United States"), 
                     values = c("#0E879C", "#E57200", "#232D4B")) +
  labs(x = "University", y = "Number of Users", color = "Country", title = "Top-20 Universities by Number of Users") +
  #theme_classic() +
  coord_flip() +
  theme_minimal() +
  theme(plot.title = element_text(size=23, hjust = 0.5),
        axis.title =element_text(size=18),
        axis.title.y =element_blank(),
        axis.text.x = element_text(size = 18),
        axis.text.y = element_text(size = 16),
        legend.title=element_text(size=18, hjust = 0.5, face="bold"),
        legend.text=element_text(size=18),
        legend.position = c(.9, .1),
        legend.justification = c("right", "bottom"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6),
        legend.background = element_rect(fill="white",
                                  size=0.5, linetype="solid", 
                                  colour ="black")) 
```
```{r institutions_table, message = FALSE,  warning = FALSE, echo=FALSE}
datatable(transmute(academic_counts, organization = organization, n = n, country = country))
```

### Top Universities in the United States 

Here we focus specifically on the US. The figure below details which US universities have the greatest number of contibutors to OSS, with the color indicating if the school is public or private. 

```{r, us_universities, fig.height = 9, fig.width = 12,  warning = FALSE, echo=FALSE, message=FALSE}
us_academic_counts <- academic_counts_sorted %>% filter(country == "United States")

top_us_universities <- select(us_academic_counts[(.N-20):.N, ], organization) %>%
  add_column(shorter = c("Arizona State University",
                         "UC Los Angeles",
                         "Purdue University",
                         "University of Wisconsin",
                         "University of Pennsylvania",
                         "Harvard University",
                         "UC San Diego",
                         "Duke University",
                         "Georgia Tech",
                         "University of Texas",
                         "Columbia University",
                         "University of Illinois",
                         "University of Michigan",
                         "New York University",
                         "Carnegie Mellon University",
                         "University of Washington",
                         "Cornell University",
                         "Univ. of Southern California",
                         "Stanford University",
                         "MIT",
                         "UC Berkeley")) %>%
  inner_join(us_academic_counts) %>%
  arrange(n) %>%
  dt_mutate(shorter = factor(shorter, levels = shorter))

Type <- c("university of california, berkeley" = "Public",
          "massachusetts institute of technology" = "Private",
          "stanford university" = "Private",
          "university of southern california" = "Private",
          "cornell university" = "Private",
          "university of washington" = "Public",
          "carnegie mellon university" = "Private",
          "new york university" = "Private",
          "university of michigan - ann arbor" = "Public",
          "university of illinois at urbana-champaign" = "Public",
          "columbia university" = "Private",
          "university of texas at austin" = "Public",
          "georgia institute of technology" = "Public",
          "duke university" = "Private",
          "university of california, san diego" = "Public",
          "harvard university" = "Private",
          "university of pennsylvania" = "Private",
          "university of wisconsin - madison" = "Public",
          "purdue university" = "Public",
          "university of california, los angeles" = "Public",
          "arizona state university" = "Public") %>% rev()

ggplot(top_us_universities, aes(color = Type)) +
  geom_point(aes(x = shorter, y = n), size = 4) +
  geom_segment(data = top_us_universities, mapping = aes(x = shorter, xend = shorter, y = 0, yend = n), size = 1) +
  labs(x = "Academic Institution", y = "Number of Users", title = "Top-20 Universities in the United States") +
  scale_color_manual(values = c("Public" = "#0E879C", "Private" = "#E57200")) +
  #scale_y_reverse() +
  coord_flip() +
  theme_minimal() +
  theme(plot.title = element_text(size=23, hjust = 0.5),
        axis.title =element_text(size=18),
        axis.title.y =element_blank(),
        axis.text.x = element_text(size = 18),
        axis.text.y = element_text(size = 16),
        legend.title=element_text(size=18, hjust = 0.5, face="bold"),
        legend.text=element_text(size=18),
        legend.position = c(.9, .1),
        legend.justification = c("right", "bottom"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6),
        legend.background = element_rect(fill="white",
                                  size=0.5, linetype="solid", 
                                  colour ="black")) 
```

### Limitations and Future Steps 

There are limitations to the methods we used to categorize users into the academic sector. For one, we relied heavily on the university dataset from Hipo Labs, which is not without its own flaws, including consistency and coverage. Also, both we, the researchers, and Hipo Labs are based in North America, which likely means that we more accurately accounted for the academic institutions located here than those in the rest of the world. This is compounded with the fact the GitHub is also a US-based company and is a common software hosting platform here, but there may be other popular options in different parts of the world that we are not accounting for. 

Additionally, some compromises had to be made concerning university systems, or universities with multiple campuses. In general, for simplicity, we only categorized users into the flapship institution/campus for that system. For example, any user whose self-reported affiliation includes "University of Michigan" was grouped into "University of Michigan - Ann Arbor", even if they were actually affiliated with the Flint campus of the university. However, there are a few exceptions: the campuses of the University of California system and the University of Illinois system were treated as separate, as were the member institutions of the University of London.

Other concerns include users reporting affiliations with more than one institution and users reporting their affiliations in different languages. 





```{r}

# goals: (1) match academic users with abbreviations and (2) match users with regex univ/college strings
## now lets pull in our ipeds data and clean it so we can grab all the abbreviations 
setwd("/sfs/qumulo/qhome/kb7hp/oss-data")
ipeds_hd2018 <- read.csv("ipeds_hd2018.csv", encoding = "UTF-8", na.strings=c("","NA"))

## define a helper function for transforming the empty rows to NA 
empty_as_na <- function(x){
    if("factor" %in% class(x)) x <- as.character(x) ## since ifelse wont work with factors
    ifelse(as.character(x)!="", x, NA)
}

# pull out all the abbreviations from IPEDS 
ipeds <- ipeds_hd2018 %>% 
  select(INSTNM, IALIAS) %>% 
  rename(institution = INSTNM, alias = IALIAS) %>% 
  mutate(institution = as.character(institution),
         alias = as.character(alias)) %>% 
  separate_rows(alias, sep = "\\|" , convert = FALSE) %>% 
  mutate(alias = str_trim(alias, side = "both")) %>% 
  dplyr::mutate_each(funs(empty_as_na)) %>% 
  drop_na(alias) 


# first, lets bind matched_academic with users_gh
ipeds_recoding <- users_gh %>% 
  full_join(matched_academic, by = "login") %>% 
  mutate(is_academic = replace_na(is_academic, 0)) %>% 
  select(login, email, company, is_academic, everything())

# 
ipeds_recoding %>% 
  dt_mutate(new_col = ifelse(test = str_detect(string = company, 
                             pattern = ipeds$alias),
                             yes = ipeds$institution, no = "remove-me")) %>% 
  filter(new_col != "remove-me") %>% 
  select(login, company, new_col)

ipeds <- ipeds %>% 
  filter(institution != "University of Puerto Rico-Mayaguez" & institution != "Northwestern College-Chicago Campus" & institution != "Northwestern College-Southwestern Campus")

# from the ipeds table, pull out the abbreviations 
alias_list <- paste(c("\\b(?i)(zqx", na.omit(ipeds$alias), "zqx)\\b"), collapse = "|")

```





















