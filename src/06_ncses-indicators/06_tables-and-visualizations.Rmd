---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
rm(list = ls())

knitr::opts_chunk$set(echo = TRUE)

library("tidyverse")
library("janitor")

raw_collab_matrix <- read.csv("~/git/oss-2020/data/intl-indicator-output/oss_intl_collaborations_2019.csv", sep=";")

# calculate total collaborations 
total_collaboration_counts <- raw_collab_matrix %>%
  clean_names() %>% 
  replace(is.na(.), 0) %>%
  select_if(is.numeric) %>%
  summarise_all(funs(sum(.))) %>% 
  t %>% as.data.frame %>% 
  rownames_to_column() %>% 
  rename(country = rowname, num_collabs = V1)

# impute zeroes into the matrix now 
country_names <- raw_collab_matrix %>% select(Country)
imputed_collab_matrix <- raw_collab_matrix %>% select(-Country)
diag(imputed_collab_matrix) <- 0
imputed_collab_matrix <- cbind(country_names, imputed_collab_matrix)
imputed_collab_matrix

# calculate non-self collaborations 
foreign_collaboration_counts <- imputed_collab_matrix %>%
  clean_names() %>% 
  replace(is.na(.), 0) %>%
  select_if(is.numeric) %>%
  summarise_all(funs(sum(.))) %>% 
  t %>% as.data.frame %>% 
  rownames_to_column() %>% 
  rename(country = rowname, num_foreign = V1)

collab_df <- total_collaboration_counts %>% 
  left_join(foreign_collaboration_counts, by = "country") %>% 
  mutate(num_domestic = num_collabs - num_foreign,
         prc_foreign = round(num_foreign / num_collabs * 100, 2),
         prc_domestic = 100.00 - prc_foreign) %>% 
  arrange(-num_collabs)

collab_df

```

```{r, fig.width=10, fig.height=5}
collab_df %>% 
  slice_max(num_collabs, n = 15) %>% 
  select(country, num_domestic, num_foreign) %>% 
  pivot_longer(!country, names_to = "collaborations", values_to = "count") %>% 
  mutate(country = str_replace(country, "united_states", "United States"), country = str_replace(country, "germany", "Germany"),
         country = str_replace(country, "united_kingdom", "United Kingdom"), country = str_replace(country, "china", "China"),
         country = str_replace(country, "france", "France"), country = str_replace(country, "india", "India"),
         country = str_replace(country, "canada", "Canada"), country = str_replace(country, "australia", "Australia"),
         country = str_replace(country, "russia", "Russia"), country = str_replace(country, "netherlands", "Netherlands"),
         country = str_replace(country, "japan", "Japan"), country = str_replace(country, "brazil", "Brazil"),
         country = str_replace(country, "switzerland", "Switzerland"), country = str_replace(country, "sweden", "Sweden"),
         country = str_replace(country, "poland", "Poland")) %>% 
  mutate(country = as.factor(country), country = fct_relevel(country, 
                               "United States", "Germany", "United Kingdom", "China", "France",
                               "India", "Canada", "Australia", "Russia", "Netherlands",
                               "Japan", "Brazil", "Switzerland", "Sweden", "Poland")) %>%
  ggplot(., aes(fill=collaborations, y=count, x=country)) + 
    geom_bar(position="stack", stat="identity", width = 0.6) +
  theme_minimal() + 
  theme(legend.position="bottom", 
        title =element_text(size=10, hjust = 1),
        axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 35, hjust = 0.9)) +
  scale_fill_discrete(name = "", labels = c("Domestic Collaborations", "International Collaborations")) +
  labs(title = "International collaborations on GitHub, for the 15 largest producing countries by GitHub commits: 2019", 
       x = "Country", y = "Number of GitHub Collaborations Per Country") +
  scale_fill_manual(values = c("#d62828","#457b9d"))
```










```{r}
top_15_countries <- c("United States", "China", "Germany", "United Kingdom", "India",
                      "Canada", "Brazil", "France", "Russia", "Japan", 
                      "Australia", "Netherlands", "Spain", "Poland", "Sweden")

oss_intl_collaborations_2019_prcs %>% 
  select(country, united_states, china, germany, united_kingdom, india,
         canada, brazil, france, russia, japan, 
         australia, netherlands, spain, poland, sweden) %>% 
  filter(country %in% top_15_countries) %>% 
  arrange(-united_states)
```

```{r}
oss_intl_collaborations_2019_prcs %>% 
  select(country, united_states) %>% 
  #filter(country %in% top_15_countries) %>% 
  arrange(-united_states)
```
```{r}

oss_intl_collaborations_2019_prcs %>% 
  select(country, united_states, row_sum)

quick_calc <- oss_intl_collaborations_2019 %>%
  clean_names() %>% 
  mutate(row_sum = rowSums(select_if(., is.numeric), na.rm = TRUE)) %>% 
  select(country, row_sum) 

```














