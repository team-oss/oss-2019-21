---
title: 'Sectoring Open Source Software'
description: 'Symposium Presentation of the 2020 DSPG Project'
weight: 1
output: html_document
---

```{css, echo=FALSE}
/* this chunk of code centers all of the headings */
h1, h2, h3, h4, h5 {
  text-align: center;
}
```

<br>
<br>
<br>
<br>
<br>

<center>
![](/findings/sectoring-oss_files/dspg-small.jpg)
</center>

## Sectoring Open Source Software: <br> Where Do GitHub Contributions Come From?

#### Crystal Zang, Morgan Klutzke, Daniel Bullock, <br> Brandon Kramer, Gizem Korkmaz, and José Bayoán Santiago Calderón <br> Sponsors: Carol Robbins (NCSES) and Ledia Guci (NCSES)

<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>

## Why Study Open Source Software? 

<center>
![](/findings/sectoring-oss_files/oss.png)
</center>

#### OSS is any software that is developed by a copyright holder, <br/> but shared with a broader public to share with anyone and for any purpose

#### Current NCSES and other economic indicators do not measure <br/> the scope and impact of OSS developed outside the business sector

<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
 




## Sectoring Open Source Software on GitHub


### Our two main goals for the 2020 DSPG Summer Project were to: 

#### (1) Classify GitHub users into one of five economic sectors 
#### (Academic, Business, Household, Government and Non-Profit) 

#### (2) Examine where GitHub users are located around the world

```{r message=FALSE, warning=FALSE, echo=FALSE, paged.print=FALSE}
library(collapsibleTree)
library(dplyr)
library(tidyr)

OSS <- data.frame(
    Sector = c(
        "Academic", "Academic","Academic", "Academic", "Academic",    
        "Academic","Academic","Academic","Academic","Academic",
        "Academic","Academic","Academic","Academic","Academic", 
        "Academic",
      
        
        "Business","Business","Business","Business","Business", 
        "Business", "Business", "Business", "Business", "Business",
          "Business","Business","Business","Business","Business", 
        "Business", "Business", "Business", "Business", "Business",
          "Business","Business","Business","Business","Business", 
        "Business", "Business", "Business", "Business", "Business",
        "Business","Business",
       
        "Household", "Household", "Household", "Household", "Household", "Household", "Household",
      "Household","Household", "Household","Household", "Household",
        
        "Government", "Government","Government","Government","Government",
        "Government","Government", "Government", "Government","Government",
        "Government", "Government","Government", "Government","Government",
        "Government","Government","Government","Government", "Government",
        "Government","Government", "Government",  "Government",
        
        "Nonprofit","Nonprofit","Nonprofit","Nonprofit","Nonprofit",
         "Nonprofit","Nonprofit","Nonprofit","Nonprofit","Nonprofit",  
        "Nonprofit","Nonprofit","Nonprofit","Nonprofit","Nonprofit",
         "Nonprofit","Nonprofit","Nonprofit","Nonprofit","Nonprofit",
        "Nonprofit",
        
        "Geographic","Geographic","Geographic",  "Geographic","Geographic",
        "Geographic","Geographic","Geographic",  "Geographic","Geographic",
        "Geographic","Geographic","Geographic",  "Geographic"
    ),
    DataSource = c(
         #academic
        "GHTorrent", "GHTorrent", "GHTorrent", "GHTorrent", "GHTorrent", "GHTorrent", "GHTorrent",
        "GitHub","GitHub", "GitHub","GitHub","GitHub",
        "Hipo Labs", "Hipo Labs","Hipo Labs","Hipo Labs",
        
      #business
      "GHTorrent", "GHTorrent", "GHTorrent", "GHTorrent", "GHTorrent", "GHTorrent", "GHTorrent",
      "GitHub","GitHub", "GitHub","GitHub","GitHub",

      
      "Forbes 2018 Fortune-1000",  "Forbes 2018 Fortune-1000", "Forbes 2018 Fortune-1000", "Forbes 2018 Fortune-1000","Forbes 2018 Fortune-1000","Forbes 2018 Fortune-1000","Forbes 2018 Fortune-1000",
      
      "Forbes 2019 Fortune-1000",  "Forbes 2019 Fortune-1000", "Forbes 2019 Fortune-1000", "Forbes 2019 Fortune-1000","Forbes 2019 Fortune-1000","Forbes 2019 Fortune-1000","Forbes 2019 Fortune-1000",
      
      "Forbes 2020 Global-2000", "Forbes 2020 Global-2000", "Forbes 2020 Global-2000", "Forbes 2020 Global-2000", "Forbes 2020 Global-2000", "Forbes 2020 Global-2000",
     
      #household
       "GHTorrent", "GHTorrent", "GHTorrent", "GHTorrent", "GHTorrent", "GHTorrent", "GHTorrent",
      "GitHub","GitHub", "GitHub","GitHub","GitHub",
      
    #gov  
      "GHTorrent", "GHTorrent", "GHTorrent", "GHTorrent", "GHTorrent", "GHTorrent", "GHTorrent",
      "GitHub","GitHub", "GitHub","GitHub","GitHub",
      "US Gov A-Z Index", "US Gov A-Z Index", "US Gov A-Z Index", "US Gov A-Z Index",
      "US Gov FFRDCs", "US Gov FFRDCs", "US Gov FFRDCs", "US Gov FFRDCs", "US Gov FFRDCs", "US Gov FFRDCs",
      "US Gov Manual", "US Gov Manual",
    
    #non profit
      "GHTorrent", "GHTorrent", "GHTorrent", "GHTorrent", "GHTorrent", "GHTorrent", "GHTorrent",
      "GitHub","GitHub", "GitHub","GitHub","GitHub",
   
      "Forbes Top-100 Charities","Forbes Top-100 Charities","Forbes Top-100 Charities", "Forbes Top-100 Charities", "Forbes Top-100 Charities", 
   
      "United Nation NGOs", "United Nation NGOs", 
      "US Gov FFRDCs", "US Gov FFRDCs",
    
     #international
      "GHTorrent", "GHTorrent", "GHTorrent", "GHTorrent", "GHTorrent", "GHTorrent", "GHTorrent",
      "GitHub","GitHub", "GitHub","GitHub","GitHub",
      "DataHub" , "DataHub" 
    ),
    Variables = c(
       #academic
        "login(rename, username)", "company (affiliation)", "city", "state","country code", "latitude",  "longitude",  #7
        "username","commits", "additions", "deletions", "created at", #5
        "institution name", "country code", "email domain", "website",  #4
        
        #business
         "login(rename, username)","company (affiliation)","city","state","country code",  "latitude",  "longitude",  #7 
        "username","commits", "additions", "deletions", "created at", #5
        
        "company", "industry", "location", "revenue", "profits", "assets", "market value",  #7
         "company", "industry", "location", "revenue", "profits", "assets", "market value",  #7
         "company", "country", "sales", "profits", "assets",  "market value", #6
        
        #household
         "login(rename, username)", "company (affiliation)", "city", "state","country code", "latitude",  "longitude",  #7
        "username","commits", "additions", "deletions", "created at", 
        
        #gov
        "login(rename, username)","company (affiliation)","city","state","country code",  "latitude",  "longitude", 
        "username","commits", "additions", "deletions", "created at",
        "gov branch", "gov agency", "gov subagency", "website",
        "ffrdc", "ffrdc admin", "ffrdc url", "ffrdc location", "gov agency", "gov subagency",
        "gov branch", "gov agency",
        
         #nonprofit
        "login(rename, username)","company (affiliation)","city","state","country code",  "latitude",  "longitude", 
        "username","commits", "additions", "deletions", "created at",
        
        "organization","acronym", "private support", "total revenue", "donor dependency", 
   
      "organization", "acronym", 
      "ffrdc", "ffrdc admin", 
      
        "login(rename, username)","company (affiliation)","city","state","country code",  "latitude",  "longitude", 
        "username","commits", "additions", "deletions", "created at",
        "continent name", "country code"
    )
)


collapsibleTree(OSS, 
                c("Sector", "DataSource", "Variables"), 
                collapsed = T,
                fill ="#E57200"
)
```

<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>

## Methods

<center>
![](/findings/sectoring-oss_files/microsoft-example.png)

![](/findings/sectoring-oss_files/ucsd-example.png)

</center>

#### We relied on aspects of computational text analysis to standardize entries 
#### (regular expressions, list matching, and bigrams)

<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>

## Sectoring Results

```{r pull_data, message = FALSE, results = FALSE, warning = FALSE, echo=FALSE}
# load packages 
for (pkg in c("tidyverse", "igraph", "visNetwork", "data.table", "R.utils", "DT",
              "RPostgreSQL", "cowplot", "maditr", "stringr", "stringi", "gridExtra")) {library(pkg, character.only = TRUE)}

# connect to postgresql to get our data
conn <- dbConnect(drv = PostgreSQL(), 
                  dbname = "sdad", 
                  host = "10.250.124.195", 
                  port = 5432, 
                  user = Sys.getenv("db_userid"), 
                  password = Sys.getenv("db_pwd"))

# query the users_gh data from github data 
github_users <- dbGetQuery(conn, "SELECT login, email, company FROM gh.ctrs_extra;")

academic <- dbGetQuery(conn, "SELECT login, company_cleaned, is_academic FROM gh.sna_ctr_academic;")
government <- dbGetQuery(conn, "SELECT login, is_gov FROM gh.sna_ctr_gov;")
nonprofit <- dbGetQuery(conn, "SELECT login, is_nonprofit FROM gh.sna_ctr_nonprofits;")

# disconnect from postgresql database 
dbDisconnect(conn)

# joining the datasets 
combined_user_data <- github_users %>% 
  full_join(academic, by = "login") %>% 
  mutate(is_academic = replace_na(is_academic, 0))

combined_user_data <- combined_user_data %>% 
  full_join(government, by = "login") %>% 
  mutate(is_gov = replace_na(is_gov, 0))

combined_user_data <- combined_user_data %>% 
  full_join(nonprofit, by = "login") %>% 
  mutate(is_nonprofit = replace_na(is_nonprofit, 0))

# household 
household <- read.csv("/sfs/qumulo/qhome/kb7hp/git/dspg20oss/ossPy/keyFiles/individualKeys.csv", header=FALSE)
household <- household %>% 
  rename(strings = V1) %>% 
  mutate(strings = as.character(strings))
household$strings <- substring(household$strings, 2)
household$strings <- substr(household$strings,1, nchar(household$strings)-1)

combined_user_data <- combined_user_data %>% 
  mutate(is_household = ifelse(test = str_detect(string = company, 
         pattern = paste(c("\\b(?i)(z3x", na.omit(household$strings), 
         "z3x|self-employed|unemployed|available for hire)\\b"), collapse = "|")), 
         yes = TRUE, no = NA)) %>% 
  mutate(is_household = replace_na(is_household, 0))

# null values 
null_values <- read.csv("/sfs/qumulo/qhome/kb7hp/git/dspg20oss/ossPy/keyFiles/nullKeys.csv", header=FALSE)
null_values <- null_values %>% 
  rename(strings = V1) %>% 
  mutate(strings = as.character(strings))
null_values$strings <- substring(null_values$strings, 2)
null_values$strings <- substr(null_values$strings,1, nchar(null_values$strings)-1)

combined_user_data <- combined_user_data %>% 
  mutate(is_nullvalue = ifelse(test = str_detect(string = company, 
         pattern = paste(c("\\b(?i)(z3x", na.omit(null_values$strings), "z3x)\\b"), collapse = "|")), 
         yes = TRUE, no = NA)) %>% 
  mutate(is_nullvalue = replace_na(is_nullvalue, 0)); combined_user_data

# implementing daniel's approaches 
legal_entities <- read.csv("/sfs/qumulo/qhome/kb7hp/git/dspg20oss/ossPy/keyFiles/curatedLegalEntitesRaw.csv", header=FALSE)
legal_entities <- legal_entities %>% 
  rename(strings = V1) %>% 
  mutate(strings = as.character(strings))
legal_entities$strings <- substring(legal_entities$strings, 2)
legal_entities$strings <- substr(legal_entities$strings,1, nchar(legal_entities$strings)-1)

symbol_strings <- read.csv("/sfs/qumulo/qhome/kb7hp/git/dspg20oss/ossPy/keyFiles/symbolRemove.csv", header=FALSE)
symbol_strings <- symbol_strings %>% 
  rename(strings = V1) %>% 
  mutate(strings = as.character(strings))
symbol_strings$strings <- substring(symbol_strings$strings, 2)
symbol_strings$strings <- substr(symbol_strings$strings,1, nchar(symbol_strings$strings)-1)
symbol_strings <- symbol_strings %>% slice(-17:-20)

curated_domains <- read.csv("/sfs/qumulo/qhome/kb7hp/git/dspg20oss/ossPy/keyFiles/curatedDomains.csv", header=FALSE)
curated_domains <- curated_domains %>% 
  rename(strings = V1) %>% 
  mutate(strings = as.character(strings))
curated_domains$strings <- substring(curated_domains$strings, 2)
curated_domains$strings <- substr(curated_domains$strings,1, nchar(curated_domains$strings)-1)

combined_user_data <- combined_user_data %>% 
  mutate(company_original = company) %>%
  mutate(company = str_replace_all(company, paste(c("(?i)(zqx", na.omit(legal_entities$strings), 
                                                    "zqx|, Inc.)"), collapse = "|"), "")) %>% 
  mutate(company = str_replace_all(company, paste(c("(?i)(zqx", na.omit(symbol_strings$strings), 
                                                    ", $|,$|zqx)"), collapse = "|"), "")) %>%
  mutate(company = str_replace_all(company, paste(c("(?i)(zqx", na.omit(curated_domains$strings), 
                                                    "zqx)"), collapse = "|"), "")) %>%
  mutate(company = tolower(company)); combined_user_data
  #filter(grepl(".br", company_original)) %>% 
  #select(company, company_original)

#### additional cleaning steps 
potential_business <- combined_user_data %>%
  select(-company_cleaned, -company_original) %>% 
  filter(is_academic == 0 & is_gov == 0 & is_nonprofit == 0 & is_household == 0 & is_nullvalue == 0) %>% 
  filter(company != "china" & company != "japan" & company != "none" & company != "no"); potential_business 

company_totals <- potential_business %>% 
  group_by(company) %>% 
  count() %>% 
  arrange(-n)# %>% filter(grepl("microsoft", company))

# this bit classifies an additional 6,000 academic developers 
new_academic_list <- company_totals %>% 
  filter(grepl("university|college", company)) %>% 
  filter(n > 1) %>% 
  rename(institutions = company); new_academic_list

combined_user_data <- combined_user_data %>% 
  mutate(new_academic = ifelse(test = str_detect(string = company, 
         pattern = paste(c("\\b(?i)(z3x", na.omit(new_academic_list$institutions), "z3x)\\b"), collapse = "|")), 
         yes = TRUE, no = NA)) %>% 
  mutate(new_academic = replace_na(new_academic, 0))

potential_business <- combined_user_data %>%
  filter(is_academic == 0 & is_gov == 0 & is_nonprofit == 0 & is_household == 0 & is_nullvalue == 0 & new_academic == 0) %>% 
  filter(company != "china" & company != "japan" & company != "none" & company != "no"); potential_business 
  #%>% drop_na(email)

company_totals <- potential_business %>% 
  group_by(company) %>% 
  count(company) %>% 
  arrange(-n) %>% 
  filter(n != 4601) %>% 
  rename(total = n) ; company_totals# %>% filter(grepl("microsoft", company))

business <- combined_user_data %>% 
  full_join(company_totals, by = "company") %>% 
  select(login, company, total) %>% 
  filter(total > 5) %>% 
  select(-total, -company) %>% 
  mutate(is_business = 1) 

combined_user_data <- combined_user_data %>% 
  full_join(business, by = "login") %>% 
  mutate(is_business = replace_na(is_business, 0))

combined_user_data %>% 
  filter(is_academic == 1 | new_academic == 1) %>% 
  count()

combined_user_data %>% 
  filter(is_gov == 1) %>%
  count()

combined_user_data %>% 
  filter(is_nonprofit == 1) %>%
  count()

combined_user_data %>% 
  filter(is_household == 1) %>%
  count()

combined_user_data %>% 
  filter(is_business == 1) %>%
  count()

final_counts <- data.frame(sector = as.factor(c("business", "academic","houshold","government", "nonprofit")),
                           total = as.numeric(c("115893", "46403", "5455", "3576", "823")))

positions <- c("business", "academic","houshold","government", "nonprofit")
```

```{r, fig.height = 7, fig.width=12, echo=FALSE}
ggplot(data=final_counts, aes(x=sector, y=total)) +
  geom_bar(stat="identity",  fill = c("#232D4B", "#E57200", "#0E879C", "#D9E12B",  "#ADD8E6")) +
  scale_x_discrete(limits = positions) +
  theme_minimal() +
  theme(plot.title = element_text(size=23, hjust = 0.45),
        axis.text.y = element_text(size = 16),
        axis.text.x = element_text(size = 16),
        axis.title =element_text(size=18),
        axis.title.x=element_blank()) +
  labs(y = "Number of GitHub Users") +
  ggtitle("Total GitHub Users Classified by Economic Sector")
```

#### Twenty percent of the GHTorrent data (~2.1 million) provides email address or work <br/> affiliation for sectoring, which gives us ~420,000 GitHub users. 

<br>

#### Most users fall into the business sector followed by <br/> the academic, household and government sectors.

<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>

## Business Sector

<center>
![](/findings/sectoring-oss_files/wordcloud.svg){width=80%}
</center>

```{r, echo=FALSE, fig.height = 8, fig.width=12}

top20companies <- company_totals %>% 
  filter(total > 399)

company_positions <- data.frame(company = c("microsoft", "google","red hat", "ibm", "facebook",
                                                 "intel", "thoughtworks","alibaba","tencent", "amazon",
                                                 "baidu", "esri","sap","shopify", "mozilla",
                                                 "pivotal", "oracle","salesforce","yandex", "linkedin"), 
                                   countries = as.factor(c("usa","usa","usa","usa","usa",
                                                 "usa","usa","china","china","usa",
                                                 "china", "usa", "germany", "canada", "usa",
                                                 "usa","usa","usa","russia","usa"))) 
top20companies <- top20companies %>% 
  full_join(company_positions, by = "company")

top20companies$company <- fct_relevel(top20companies$company, 
                                      "linkedin", "yandex","salesforce", "oracle", "pivotal",
                                      "mozilla","shopify", "sap", "esri", "baidu",
                                      "amazon", "tencent", "alibaba", "thoughtworks", "intel",
                                      "facebook", "ibm","red hat", "google","microsoft")
 
ggplot(top20companies) +
  geom_point(aes(x = company, y = total, colour = countries), size = 4) +
  geom_segment( aes(x=company, xend=company, y=0, yend=total, colour = countries)) +
  #ggtitle("Most Prominent Businesses\nDeveloping OSS (By GitHub Users)") +
  coord_flip() +
  theme_minimal() +
  scale_color_manual(labels=c("canada", "china",   "germany", "russia", "usa"),
                     values=c("#D9E12B", "#232D4B", "#0E879C",  "#ADD8E6", "#E57200")) +
  theme(plot.title = element_text(size=23, hjust = 0.5),
        #axis.title.x=element_blank(),
        axis.title =element_text(size=18),
        axis.title.y =element_blank(),
        #axis.text.x = element_text(size = 18),
        axis.text.y = element_text(size = 16),
        axis.text.x = element_text(size = 16),
        legend.title=element_text(size=18, hjust = 0.5, face="bold"),
        legend.text=element_text(size=18),
        legend.position = c(.9, .1),
        legend.justification = c("right", "bottom"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6),
        legend.background = element_rect(fill="white",
                                  size=0.5, linetype="solid", 
                                  colour ="black")) +
  labs(y = "Total GitHub Users", title = "Most Prominent Businesses\nDeveloping OSS (By GitHub Users)") 
```

#### Most OSS producing companies are large tech companies based in Silicon Valley

<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>

## Academic Sector

```{r academic, include=FALSE, message=FALSE, warning=FALSE}
# load packages 
for (pkg in c("data.table", "R.utils", "DT",
              "RPostgreSQL", "cowplot", "maditr", "stringr", "stringi", "gridExtra", "ggplot2")) {library(pkg, character.only = TRUE)}

# connect to postgresql to get our data
conn <- dbConnect(drv = PostgreSQL(), 
                  dbname = "sdad", 
                  host = "10.250.124.195", 
                  port = 5432, 
                  user = Sys.getenv("db_userid"), 
                  password = Sys.getenv("db_pwd"))

# query the users_gh data from github data 
users_gh <- dbGetQuery(conn, "SELECT login, email, company
                              FROM gh.ctrs_extra")

institutions_hipolabs <- dbGetQuery(conn, "SELECT institution, country, domains FROM hipolabs.universities")

# disconnect from postgresql database 
dbDisconnect(conn)

institutions_hipolabs <- institutions_hipolabs %>% 
  as.data.table() %>% 
  # convert to lower case
  dt_mutate(institution = str_to_lower(institution)) %>%
  # remove duplicates
  distinct() %>%
  # add category for students
  add_row(institution = "misc. student") %>%
  # add academic/research organizations present in users_gh but not in hipo labs data
  add_row(institution = "university of tokyo", country = "Japan", domains = "u-tokyo.ac.jp") %>%
  add_row(institution = "aalto university", country = "Finland", domains = "aalto.fi") %>%
  add_row(institution = "international institute of information technology, hyderabad", country = "India", domains = "iiit.ac.in") %>%
  #add_row(institution = "broad institute", country = "United States", domains = "broadinstitute.org") %>%
  #add_row(institution = "cern", country = "Switzerland", domains = "cern.ch") %>%
  #add_row(institution = "inria", country = "France", domains = "inria.fr") %>%
  #add_row(institution = "cnrs", country = "France", domains = "cnrs.fr") %>%
  add_row(institution = "space telescope science institute", country = "United States", domains = "stsci.edu") %>%
  #add_row(institution = "wellcome trust sanger institute", country = "United Kingdom", domains = "sanger.ac.uk") %>%
  add_row(institution = "hasso plattner institute", country = "Germany", domains = "hpi.de") %>%
  dt_mutate(institution = if_else(institution == "xi'an university of electronic science and technology", "xidian university", institution))

length(users_gh$company) 
# 2,143,407 total entries 
# note: there are actually 2,435,698 total users

valid_company_codes <- users_gh %>% drop_na(company) 
length(valid_company_codes$company)
# 422517 users with some company_code information 
length(valid_company_codes$company) / length(users_gh$company)
# putting us at 19.7124% that are identifiable for now 

# organize by company
orgs_initial <- users_gh %>% 
  drop_na(company) %>% 
  dt_mutate(organization = str_to_lower(company)) %>% 
  group_by(organization) %>% count() %>% arrange(-n)

# compare with hipo labs dataset
initial_overlap <- semi_join(orgs_initial, institutions_hipolabs, by = c("organization" = "institution"))
sum(initial_overlap[,"n"])
# 16,677 identified users from academic institutions

orgs_clean <- users_gh %>%
  # remove all na's 
  drop_na(company) %>% 
  # convert to lower case 
  dt_mutate(organization = str_to_lower(company)) %>%
  # remove @ from start of names 
  dt_mutate(organization = str_replace_all(organization, "@", " ")) %>% 
  # remove uninformative words "inc." and "the"
  dt_mutate(organization = str_replace_all(organization, "\\b(, inc\\.|, inc| inc\\.| inc|\\.$)\\b", "")) %>%
  dt_mutate(organization = str_replace_all(organization, "\\b(the )\\b", "")) %>%
  # expand abbreviations "univ." and "iit"
  dt_mutate(organization = str_replace_all(organization, "\\b(univ\\.|univ)\\b", "university")) %>%
  dt_mutate(organization = str_replace_all(organization, "\\b(iit)\\b", "indian institute of technology,")) %>%
  dt_mutate(organization = str_trim(organization)) %>% 
  # classifying students
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(student)\\b"), 
                              yes = "misc. student", no = organization)) %>%
  # universities and research institutes 
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(duke university|duke|duke university libraries|dukeuniversity)\\b"), 
                              yes = "duke university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
  pattern = "\\b(?i)(stanford university|stanford|stanfordmlgroup|stanfordvl|stanfordgeospatialcenter|stanfordhci|stanfordjournalism|stanfordmsl|stanfordnlp)\\b"), 
                              yes = "stanford university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(massachusetts institute of technology|mit|mitmedialab|mit media lab)\\b"), 
                              yes = "massachusetts institute of technology", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(harvard medical school|harvard|harvard university|harvardagileroboticslab|harvardnlp|harvardx)\\b"), 
                              yes = "harvard university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^princeton university|princeton university$|princetonuniversity|princeton)\\b"), 
                              yes = "princeton university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
  pattern = "\\b(?i)(^columbia university|columbia university$|barnard college|columbia-university)\\b"), 
                              yes = "columbia university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
  pattern = "\\b(?i)(^northeastern university|northeastern university$|northeastern)\\b"), 
                              yes = "northeastern university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
  pattern = "\\b(?i)(^northwestern university|northwestern university$|northwestern)\\b"), 
                              yes = "northwestern university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
  pattern = "\\b(?i)(^cornell university|cornell university$|northwestern|^cornell tech|cornell tech$|cornelltech|^weill cornell|weill cornell$|weill cornell medicine$|cornell|cornell lab of ornithology|cornell-dti|cornell-rpal|cornell asl|weillcornell nygenome|cornell cs|cornell unveristy|cs, cornell)\\b"), 
                              yes = "cornell university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
  pattern = "\\b(?i)(carnegie mellon|carnegie mellon university|carnegie mellon university software engineering institute|carnegie mellon university, silicon valley|cmu)\\b"), 
                              yes = "carnegie mellon university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(john hopkins|john hopkins university|johns hopkins university applied physics laboratory)\\b"), 
                              yes = "john hopkins university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(penn|upenn|pennlabs|university of pennsylvania|the university of pennsylvania|penn medicine)\\b"), 
                              yes = "university of pennsylvania", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
  pattern = "\\b(?i)(university of washington|university of washington(?! state)|univerisity of washington|univeristy of washington|universityofwashington|univesity of washington)\\b"),
                              yes = "university of washington", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization,
                              pattern = "\\b(?i)(university of california, san francisco|uc san francisco|university of california san francisco|ucsf)\\b"),
                              yes = "university of california, san francisco", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization,
                              pattern = "\\b(?i)(university of california santa barbara|uc santa barbara|ucsb)\\b"),
                              yes = "university of california, santa barbara", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization,
                              pattern = "\\b(?i)(university of california irvine|university of california, irvine|uc irvine)\\b"),
                              yes = "university of california, irvine", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization,
                              pattern = "\\b(?i)(university of california davis|university of california, davis|uc davis)\\b"),
                              yes = "university of california, davis", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization,
                              pattern = "\\b(?i)(ucla|university of california los angeles|university of california, los angeles)\\b"),
                              yes = "university of california, los angeles", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization,
                              pattern = "\\b(?i)(university of california berkeley|uc berkeley|university of california, berkeley)\\b"),
                              yes = "university of california, berkeley", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization,
                              pattern = "\\b(?i)(university of california, san diego|university of california san diego|ucsd|uc san diego)\\b"),
                              yes = "university of california, san diego", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^california state|california state$|california state university$|^california polytechnic|california polytechnic$)\\b"), 
                              yes = "california state university system", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^georgia institute of technology|^georgia tech|georgia institute of technology$|georgia tech$)\\b"), 
                              yes = "georgia institute of technology", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of british columbia|ubc)\\b"), 
                              yes = "university of british columbia", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(indiana university|indiana university bloomington|indiana university, bloomington)\\b"), 
                              yes = "indiana university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of texas at austin|university of texas|the university of texas at austin)\\b"), 
                              yes = "university of texas at austin", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^texas a&m|^texas a & m|texas a&m university)\\b"), 
                              yes = "texas a&m university - college station", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of college london|ucl|university college london)\\b"), 
                              yes = "university college london, university of london", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(new york university|nyu|nyulibraries|nyueserv|itpnyu)\\b"), 
                              yes = "new york university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(penn state|penn state university|pennsylvania state university|the pennsylvania state university|pennstate)\\b"), 
                              yes = "pennsylvania state university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
  pattern = "\\b(?i)(fred hutchinson cancer research center|fredhutch|fred hutch|fred hutchinson|fred hutchinson center|fred hutch cancer research center)\\b"), 
                              yes = "fred hutchinson cancer research center", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(shanghai jiao tong university|sjtu|jiao tong university|jiao tong)\\b"), 
                              yes = "shanghai jiaotong university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^tsinghua|tsinghua$|tsinghua university$|tsinghua univ$|tsinghua unviersity|tsinghuauniversity|tsinghua_university|tsinghuau)\\b"), 
                              yes = "tsinghua university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of michigan|university of michigan$|^the university of michigan|university of michigan, ann arbor)\\b"), 
                              yes = "university of michigan - ann arbor", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of virginia|university of virginia$|^uva|uva$)\\b"), 
                              yes = "university of virginia, charlottesville", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^virginia tech|virginia tech$|virginia tech university$|^Virginia Polytechnic)\\b"), 
                              yes = "virginia polytechnic institute and state university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of tokyo|^the university of tokyo|university of tokyo$)\\b"), 
                              yes = "university of tokyo", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of waterloo|^the university of waterloo|university of waterloo$)\\b"), 
                              yes = "university of waterloo", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^zhejiang|zhejiang university$|zju)\\b"), 
                              yes = "zhejiang university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of toronto|university of toronto$)\\b"), 
                              yes = "university of toronto", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^imperial college london|imperial college london$)\\b"), 
                              yes = "imperial college london", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of cambridge|university of cambridge$|^cambridge university|cambridge university$)\\b"), 
                              yes = "university of cambridge", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of oxford|university of oxford$|^oxford university|oxford university$|^the university of oxford|^university of oxford,)\\b"), 
                              yes = "university of oxford", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^peking university|peking university$|^peking university,)\\b"), 
                              yes = "peking university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of southern california|university of southern california$|^university of southern california,|usc)\\b"), 
                              yes = "university of southern california", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^nanjing university|^nanjing univ|nanjing university$|^nanjing university,|nju)\\b"), 
                              yes = "nanjing university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of edinburgh|university of edinburgh$|^the university of edinburgh)\\b"), 
                              yes = "university of edinburgh", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^purdue university|^purdue university,|purdue university$|department of statistics,purdue university|purdue univeristy)\\b"), 
                              yes = "purdue university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of florida|^university of florida,|university of florida$|universityofflorida)\\b"), 
                              yes = "university of florida", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of chicago|^university of chicago,|^the university of chicago|university of chicago$|^uchicago|uchicago$|^u of chicago|u of chicago$)\\b"), 
                              yes = "university of chicago", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of illinois at chicago|university of illinois chicago|university of illinois, chicago)\\b"), 
                              yes = "university of illinois at chicago", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of illinois at springfield|university of illinois springfield|university of illinois, springfield)\\b"), 
                              yes = "university of illinois at springfield", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of illinois|university of illinois at urbana-champaign|university of illinois urbana-champaign|university of illinois, urbana-champaign|university of illinois at urbana champaign|uiuc)\\b"), 
                              yes = "university of illinois at urbana-champaign", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^national university of singapore|^national university of singapore,|national university of singapore$)\\b"), 
                              yes = "national university of singapore", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^fudan|fudan university$|fudan university)\\b"), 
                              yes = "fudan university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^boston university|boston university$)\\b"), 
                              yes = "boston university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^arizona state|^arizona state,|arizona state university$|arizona state$)\\b"), 
                              yes = "arizona state university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^mcgill|mcgill university$|mcgill$)\\b"), 
                              yes = "mcgill university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^oregon state|^oregon state,|oregon state university$|oregon state$)\\b"), 
                              yes = "oregon state university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^stony brook|stony brook university$|stony brook$|^state university of new york)\\b"), 
                              yes = "state university of new york system", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of minnesota|university of minnesota$|^university of minnesota,)\\b"), 
                              yes = "university of minnesota", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(sun yat-sen university|(?=.*sun yat-sen)(?=.*guangzhou).*|sysu|zhongda)\\b"), 
                              yes = "zhongshan university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(nsysu|(?=.*sun yat-sen)(?=.*taiwan).*|national sun yat-sen)\\b"), 
                              yes = "national sun yat-sen university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of alberta|university of alberta$|^university of alberta,)\\b"), 
                              yes = "university of alberta", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of wisconsin-madison|^university of wisconsin|university of wisconsin$|university of wisconsin-madison$|university of wisconsinmadison|^university of wisconsin,|^uw-madison|uw-madison$)\\b"), 
                              yes = "university of wisconsin - madison", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^rwth aachen university|rheinisch westfalische technische hochschule aachen)\\b"), 
                              yes = "rheinisch westfälische technische hochschule aachen", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(politecnico di milano|^polytechnic institute of milan)\\b"),
                              yes = "polytechnic institute of milan", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(delft university of technology|^tu delft)\\b"),
                              yes = "delft university of technology", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(buaa|beihang university)\\b"),
                              yes = "beijing university of aeronautics and astronautics", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(tu dresden|technische universitat dresden)\\b"),
                              yes = "technische universität dresden", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of colorado|university of colorado boulder|university of colorado, boulder|university of colorado - boulder|university of colorado-boulder)\\b"),
                              yes = "university of colorado at boulder", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(katholieke universiteit leuven|ku leuven)\\b"),
                              yes = "katholieke universiteit leuven", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(eth zurich|eidgenössische technische hochschule zürich|eth zürich|swiss federal institute of technology in zurich|politecnico federale di zurigo|école polytechnique fédérale de zurich|eth zrich)\\b"),
                              yes = "ethz - eth zurich", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of maryland|university of maryland$|university of maryland - college park)\\b"),
                              yes = "university of maryland, college park", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(ohio state university|ohio state university$|^ohio state|osu)\\b"),
                              yes = "ohio state university, columbus", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of tsukuba|universityof tsukuba)\\b"),
                              yes = "tsukuba university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university at buffalo|^state university of new york$|^suny$)\\b"),
                              yes = "state university of new york at buffalo", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(technical university of munich|tu munich)\\b"),
                              yes = "technische universität münchen", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of freiburg|albert ludwig university of freiburg|albert-ludwigs-universitt freiburg|uni freiburg|freiburg university|albert ludwig university freiburg|university freiburg|universitt freiburg)\\b"),
                              yes = "albert-ludwigs-universität freiburg", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(washington university in st louis|washington university in st. louis|washington university in saint louis|washington university at st. louis)\\b"),
                              yes = "washington university, saint louis", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)((?<!it )university of copenhagen)\\b"),
                              yes = "copenhagen university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(ghent university|ugent)\\b"),
                              yes = "universiteit gent", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(newcastle university|university of newcastle)\\b"),
                              yes = "university of newcastle-upon-tyne", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(international institute of information technology hyderabad|iiit hyderabad|iiit-hyderabad)\\b"),
                              yes = "international institute of information technology, hyderabad", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(epfl)\\b"),
                              yes = "epfl - epf lausanne", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(uestc)\\b"),
                              yes = "university of electronic science and technology of china", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(bupt)\\b"),
                              yes = "beijing university of posts and telecommunications", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(ustc)\\b"),
                              yes = "university of science and technology of china", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(kaist)\\b"),
                              yes = "korea advanced institute of science & technology", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(epitech)\\b"),
                              yes = "ecole pour l'informatique et les nouvelles technologies", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(mipt)\\b"),
                              yes = "moscow institute of physics and technology", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(hkust)\\b"),
                              yes = "hong kong university of science and technology", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(caltech)\\b"),
                              yes = "california institute technology", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(scut)\\b"),
                              yes = "south china university of technology", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(unicamp)\\b"),
                              yes = "universidade estadual de campinas", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(feup)\\b"),
                              yes = "universidade do porto", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(king's college london)\\b"),
                              yes = "king's college london, university of london", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(karlsruhe institute of technology)\\b"),
                              yes = "karlsruher institut für technologie", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(nus)\\b"),
                              yes = "national university of singapore", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(ntnu)\\b"),
                              yes = "norwegian university of science and technology", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(tu berlin|technische universitat berlin)\\b"),
                              yes = "technische universität berlin", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(tu darmstadt|technische universitat darmstadt)\\b"),
                              yes = "technische universität darmstadt", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(kth)\\b"),
                              yes = "kth royal institute of technology", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(umass amherst)\\b"),
                              yes = "university of massachusetts at amherst", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(pku)\\b"),
                              yes = "peking university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(nc state university)\\b"),
                              yes = "north carolina state university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(technische universitt mnchen|tu munchen|tu münchen|tum)\\b"),
                              yes = "technische universität münchen", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(ufmg)\\b"),
                              yes = "universidade federal de minas gerais", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of so paulo|university of sao paulo)\\b"),
                              yes = "universidade de são paulo", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(linkping university|linkoping university)\\b"),
                              yes = "linköping university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of stuttgart)\\b"),
                              yes = "universität stuttgart", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(ecnu)\\b"),
                              yes = "east china normal university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(universidade de brasilia|universidade de braslia)\\b"),
                              yes = "universidade de brasília", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of hawaii)\\b"),
                              yes = "university of hawaii system", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(trinity college dublin)\\b"),
                              yes = "university of dublin, trinity college", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(cuhk)\\b"),
                              yes = "chinese university of hong kong", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(tu wien)\\b"),
                              yes = "technische universität wien", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(bits pilani)\\b"),
                              yes = "birla institute of technology and science", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(hasso plattner institut|hasso-plattner-institute|hasso-plattner-institut|hasso-plattner institut|hasso plattner institute)\\b"),
                              yes = "hasso plattner institute", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(whu)\\b"),
                              yes = "wissenschaftliche hochschule für unternehmensführung, otto-beisheim hochschule", no = organization))

# create a frequency table
org_counts <- orgs_clean %>% group_by(organization) %>% count() %>% arrange(-n) 

# compare with hipo labs dataset to pull out academic institutions
institutions_hipolabs <- institutions_hipolabs %>% as.data.table() %>% dt_mutate(institution = str_to_lower(institution))
overlap <- semi_join(org_counts, institutions_hipolabs, by = c("organization" = "institution"))
sum(overlap[,"n"])
sum(filter(overlap, organization != "misc. student")[,"n"])
filter(overlap, organization == "misc. student")$n

# make a table to see what isn't caught by hipo labs
leftover <- anti_join(org_counts, overlap)

# get just the domains from the emails
email_domains <- users_gh %>% drop_na(email) %>%
dt_mutate(domains = str_replace_all(email, "^[a-zA-Z0-9_.+-]+@", ""))

# match academic institutions from hipolabs to users based on email domains
# only impute company when it was NA
imputed_institutions <- email_domains %>%
  as.data.table() %>%
  inner_join(drop_na(institutions_hipolabs, domains)) %>%
  subset(is.na(company)) %>%
  dt_mutate(organization = institution)

nrow(imputed_institutions)
# 11,632 imputed

# join with other recoded data to update academic counts
orgs_clean <- full_join(orgs_clean, imputed_institutions[,c("login","email","organization")])
org_counts <- orgs_clean %>% group_by(organization) %>% count() %>% arrange(-n) 
overlap <- semi_join(org_counts, institutions_hipolabs, by = c("organization" = "institution"))
sum(overlap[,"n"])

# rejoin with hipo labs data
academic_counts <- overlap %>%
  left_join(institutions_hipolabs, by = c("organization" = "institution")) %>% 
  filter(!(organization == "misc. student")) # remove misc. students for future analyses

sum(academic_counts[,"n"]) 
# now there are 42,966 users?
# larger than before because it's double-counting the institutions that are in multiple countries or have multiple domains

# group together different country and domain values for the same institution
group1 <- academic_counts[duplicated(academic_counts$organization), ] %>% rename(c(country2 = country, domains2 = domains))
group2 <- group1[duplicated(group1$organization), ] %>% rename(c(country3 = country2, domains3 = domains2))
group3 <- group2[duplicated(group2$organization), ] %>% rename(c(country4 = country3, domains4 = domains3))
group4 <- group3[duplicated(group3$organization), ] %>% rename(c(country5 = country4, domains5 = domains4))

# remove duplicates so each group has unique values
group1 <- group1[!duplicated(group1$organization), ]
group2 <- group2[!duplicated(group2$organization), ]
group3 <- group3[!duplicated(group3$organization), ]
group4 <- group4[!duplicated(group4$organization), ]

# add back in the multiple countries/domains, but as additional columns
# now there is only one row for each institution
academic_counts <- academic_counts[!duplicated(academic_counts$organization), ] %>% 
  left_join(group1) %>%
  left_join(group2) %>%
  left_join(group3) %>%
  left_join(group4)

# add NAs for when multiple country listings are the same (if the duplicated institution is from multiple domains)
# or when multiple domain listings are the same (if the duplicated institution is from multiple countries)
academic_counts <- academic_counts %>%
  mutate_all(str_replace_na) %>%
  dt_mutate(country2 = if_else(country == country2, "NA", country2)) %>%
  dt_mutate(country3 = if_else(country == country3, "NA", country3)) %>%
  dt_mutate(domains2 = if_else(domains == domains2, "NA", domains2)) %>%
  dt_mutate(domains3 = if_else(domains == domains3, "NA", domains3)) %>%
  dt_mutate(domains4 = if_else(domains == domains4, "NA", domains4)) %>%
  dt_mutate(domains5 = if_else(domains == domains5, "NA", domains5))

# collapse into single columns for country/domains
# we want to avoid having multiple countries for an institution, since they'd be double-counted in the following analyses
# for the 21 institutions represented that are in multiple countries, the primary country is manually coded
academic_counts <- academic_counts %>%
  dt_mutate(country = if_else(condition = organization %chin% c("universidad simón bolivar", "suleyman demirel university", "universidad de córdoba", "aga khan university", "southeast university", "universidad de los andes", "korea university"), true = country2, false = country)) %>%
  dt_mutate(domains_combined = str_c(domains, domains2, domains3, domains4, domains5, sep = ", ")) %>%
  transmute(organization = organization, n = n, country = country, domains = domains_combined)

# remove remaining NAs
academic_counts <- academic_counts %>% 
  dt_mutate(domains = str_replace_all(domains, ", NA", "")) %>%
  dt_mutate(n = as.numeric(n)) # for some reason n got changed to chr type

length(filter(academic_counts, country == "United States")$organization) / length(academic_counts$organization)
# 33% of academic institutions represented are in the U.S.
sum(filter(academic_counts, country == "United States")[, "n"]) / sum(academic_counts[, "n"])
# 55% of users in the academic sector are at U.S. institutions
sum(academic_counts[,"n"]) / 2435698
# 1.6% of all users have been matched to an academic institution

# look at percentage of academic sector users in each country
options(scipen = 10)
country_user_percentages <- academic_counts %>% 
  group_by(country) %>% 
  select(country, n) %>% 
  summarise(n = sum(n), percentage = sum(n) / sum(academic_counts[, "n"])) %>% 
  mutate(percentage = paste0(100 * round(percentage, 5), "%")) %>% 
  arrange(-n)

academic_counts_sorted <- academic_counts %>% 
  arrange(n) %>%
  dt_mutate(organization = factor(organization, levels = organization))

```

```{r, countries_users, fig.height = 9, fig.width = 12, warning = FALSE,  message=FALSE, echo=FALSE}
#country_frequency_institutions <- academic_counts %>% group_by(country) %>% count(wt = n(), sort = TRUE)

country_frequency_users <- academic_counts %>% 
  mutate(country = tolower(country)) %>% 
  dt_mutate(country = str_replace_all(country, "korea, republic of", "south korea")) %>%
  dt_mutate(country = str_replace_all(country, "russian federation", "russia")) %>%
  group_by(country) %>% 
  count(sort = TRUE, wt = n)
country_users_sorted <- country_frequency_users %>%
  arrange(n) %>%
  dt_mutate(country = factor(country, levels = country))

continent <- c("united states" = "north america",
               "china" = "asia",
               "united kingdom" = "europe",
               "canada" = "north america",
               "germany" = "europe",
               "india" = "asia",
               "japan" = "asia",
               "switzerland" = "europe",
               "south korea" = "asia",
               "australia" = "australia",
               "brazil" = "south america",
               "netherlands" = "europe",
               "sweden" = "europe",
               "france" = "europe",
               "colombia" = "south america",
               "spain" = "europe",
               "russia" = "europe",
               "singapore" = "asia",
               "hong kong" = "asia",
               "italy" = "europe",
               "finland" = "europe") %>% rev()

ggplot(country_users_sorted[(.N-20):.N, ], aes(color = continent)) +
  geom_point(aes(x = country, y = n), size = 4) +
  geom_segment(data = country_users_sorted[(.N-20):.N, ], mapping = aes(x = country, xend = country, y = 0, yend = n), size = 1) +
  #scale_color_manual(values = c("asia" = "#E57200", "australia" = "#375758", "europe" = "#485C99", "north america" = "#12B2CE", "south america" = "#D7E029")) +
  theme_minimal() +
  labs(x = "Country", y = "Number of Users", title = "Top-20 Countries by Users in Academic Sector") +
  theme(plot.title = element_text(size=23, hjust = 0.5),
        axis.title =element_text(size=18),
        axis.title.y =element_blank(),
        axis.text = element_text(size = 18),
        legend.title=element_text(size=18, hjust = 0.5, face="bold"),
        legend.text=element_text(size=18),
        legend.position = c(.9, .1),
        legend.justification = c("right", "bottom"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6),
        legend.background = element_rect(fill="white",
                                  size=0.5, linetype="solid", 
                                  colour ="black")) +
  scale_y_log10() +
  coord_flip() +
  scale_color_manual(labels=c("asia",  "australia", "europe", "north america","south america"),
                     values=c("#232D4B", "#99BDAD",  "#E57200", "#0E879C", "#D9E12B")) 
```

#### US-based academic institutions are the largest producers of OSS

<br>
<br>
<br>
<br>
<br>

```{r, us_universities, fig.height = 9, fig.width = 12,  warning = FALSE, message=FALSE, echo=FALSE}
us_academic_counts <- academic_counts_sorted %>% filter(country == "United States")

top_us_universities <- select(us_academic_counts[(.N-20):.N, ], organization) %>%
  add_column(shorter = c("Arizona State University",
                         "UC Los Angeles",
                         "Purdue University",
                         "University of Wisconsin",
                         "University of Pennsylvania",
                         "Harvard University",
                         "UC San Diego",
                         "Duke University",
                         "Georgia Tech",
                         "University of Texas",
                         "Columbia University",
                         "University of Illinois",
                         "University of Michigan",
                         "New York University",
                         "Carnegie Mellon University",
                         "University of Washington",
                         "Cornell University",
                         "Univ. of Southern California",
                         "Stanford University",
                         "MIT",
                         "UC Berkeley")) %>%
  inner_join(us_academic_counts) %>%
  arrange(n) %>%
  dt_mutate(shorter = factor(shorter, levels = shorter))

Type <- c("university of california, berkeley" = "Public",
          "massachusetts institute of technology" = "Private",
          "stanford university" = "Private",
          "university of southern california" = "Private",
          "cornell university" = "Private",
          "university of washington" = "Public",
          "carnegie mellon university" = "Private",
          "new york university" = "Private",
          "university of michigan - ann arbor" = "Public",
          "university of illinois at urbana-champaign" = "Public",
          "columbia university" = "Private",
          "university of texas at austin" = "Public",
          "georgia institute of technology" = "Public",
          "duke university" = "Private",
          "university of california, san diego" = "Public",
          "harvard university" = "Private",
          "university of pennsylvania" = "Private",
          "university of wisconsin - madison" = "Public",
          "purdue university" = "Public",
          "university of california, los angeles" = "Public",
          "arizona state university" = "Public") %>% rev()

ggplot(top_us_universities, aes(color = Type)) +
  geom_point(aes(x = shorter, y = n), size = 4) +
  geom_segment(data = top_us_universities, mapping = aes(x = shorter, xend = shorter, y = 0, yend = n), size = 1) +
  labs(x = "Academic Institution", y = "Number of Users", title = "Top-20 Universities in the United States") +
  scale_color_manual(values = c("Public" = "#0E879C", "Private" = "#E57200")) +
  #scale_y_reverse() +
  coord_flip() +
  theme_minimal() +
  theme(plot.title = element_text(size=23, hjust = 0.5),
        axis.title =element_text(size=18),
        axis.title.y =element_blank(),
        axis.text.x = element_text(size = 18),
        axis.text.y = element_text(size = 16),
        legend.title=element_text(size=18, hjust = 0.5, face="bold"),
        legend.text=element_text(size=18),
        legend.position = c(.9, .1),
        legend.justification = c("right", "bottom"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6),
        legend.background = element_rect(fill="white",
                                  size=0.5, linetype="solid", 
                                  colour ="black"))
```

#### Most of the top OSS-producing universities are close to <br/> major tech hubs in CA, MA, NY, TX and WA 

<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>

## Geographic Analyses

```{r loading data, message=FALSE, warning=FALSE, include=FALSE}
# load packages
for (pkg in c("tidyverse", "RPostgreSQL",   "dplyr", "leaflet", "leaflet.extras", "tools", "statebins")) {library(pkg, character.only = TRUE)}

# connect to postgresql to get our data
conn <- dbConnect(drv = PostgreSQL(), 
                  dbname = "sdad", 
                  host = "10.250.124.195", 
                  port = 5432, 
                  user = Sys.getenv("db_userid"), 
                  password = Sys.getenv("db_pwd"))

# query the city code data
city_clean_final <- dbGetQuery(conn, "SELECT *
                              FROM gh.sna_ctr_city_codes")

# disconnect from postgresql database 
dbDisconnect(conn)

#https://coolors.co/232d4b-2c4f6b-0e879c-60999a-d1e0bf-d9e12b-e6ce3a-e6a01d-e57200-fdfdfd
uva_color_palette <- 
c("#232D4B", #space cadet
  "#2C4F6B", #indigo dye
  "#0E879C", #blue munsell
  "#60999A", #cadet blue
  "#D1E0BF", #tea green
  "#D9E12B", #pear
  "#E6CE3A", #citrine
  "#E6A01D", #marigold
  "#E57200" #princeton orange
)

CapStr <- function(y) {
  c <- strsplit(y, " ")[[1]]
  paste(toupper(substring(c, 1,1)), substring(c, 2),
        sep="", collapse=" ")
}

#aggregate by continent
city_clean_final_aggregate_continent<- city_clean_final%>%
  filter(!is.na(c_continent_name))%>%
  group_by(c_continent_name)%>%
  summarize(ttl_users = n(), `percent (%)` = round(ttl_users/nrow(city_clean_final)*100, digits = 2))%>%
  arrange(desc(ttl_users))

#aggregate by country
city_clean_final_aggregate_country <- city_clean_final%>%
  group_by(c_country_name)%>%
  summarize(ttl_users = n())%>%
  arrange(desc(ttl_users))
#city_clean_final_aggregate_country$country_code <- gsub(" ", "", city_clean_final_aggregate_country$country_code, fixed = TRUE)

#aggregate by U.S. state

#aggregate by city
city_clean_final_aggregate <- city_clean_final%>%
  group_by(c_city_code, c_country_name)%>%
  summarize(ttl_users = n(), lat = mean(raw_lat), long = mean(raw_long))%>%
  arrange(-ttl_users)

city_clean_final_aggregate$city <- str_extract(city_clean_final_aggregate$c_city_code,"_(.*)_") 
city_clean_final_aggregate$city <- gsub("_", "", city_clean_final_aggregate$city, fixed = TRUE)
city_clean_final_aggregate$city<- sapply(city_clean_final_aggregate$city,CapStr)

city_clean_final_aggregate$city_country <- paste(city_clean_final_aggregate$city, city_clean_final_aggregate$c_country_name, sep = ", ")


top_city_vector <- as.vector(city_clean_final_aggregate[1:10,]$c_city_code)

city_clean_final_aggregate <- city_clean_final_aggregate%>%
  mutate(top_city = if_else(c_city_code %in% top_city_vector, "topcity", "not topcity"))

gh_continent<- city_clean_final_aggregate_continent%>%
  arrange(desc(ttl_users))%>%
  mutate(c_continent_name = if_else(c_continent_name == "North America", "North \n America",
                                    if_else(c_continent_name == "South America", "South \n America", c_continent_name)))

gh_continent$Continent_Name <- factor(gh_continent$c_continent_name, levels = gh_continent$c_continent_name[order(gh_continent$ttl_users)])

min = min(gh_continent$ttl_users)
max = max(gh_continent$ttl_users)

```

### Countries Where Github Users are Located
```{r fig.width=9.5, fig.height=5, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
gh_country <- city_clean_final_aggregate_country%>%
  arrange(desc(ttl_users))%>%
  top_n(10, ttl_users)%>%
  mutate(c_country_name = if_else(c_country_name == "United Kingdom", "UK", c_country_name))

gh_country$c_country_name <- factor(gh_country$c_country_name, levels = gh_country$c_country_name[order(gh_country$ttl_users)])

gh_country$Continent <- c("North America", "Asia", "Europe", "Asia", "Europe", "Europe", "North America", "Europe", "South America", "Oceania")

gh_country$Continent <- factor(gh_country$Continent , levels =c("North America", "Asia", "Europe", "South America", "Oceania"))

min = min(gh_country$ttl_users)
max = max(gh_country$ttl_users)

ggplot(gh_country, aes(x = c_country_name, y = ttl_users, fill = Continent)) +
  geom_bar(stat = "identity")+
  labs(#title = "Countries where Github users are located", 
       x = "Country", y = "Total Number of Users") +
  theme_bw()+
  theme(legend.spacing.y = unit(1,"cm"))+
  theme(axis.text.x = element_text(size = 13, hjust = .5, vjust = .5),
        axis.text.y = element_text(size = 12, hjust = .5, vjust = .5),  
        axis.title.x = element_text(size = 14, hjust = .5, vjust = .5),
        axis.title.y = element_text(size = 14, hjust = .5, vjust = .5),
        legend.title=element_text(size=13),
        legend.text = element_text(size=11))+
  scale_y_continuous(breaks = c(0, 25000, 50000, 75000, 100000, 125000, 150000))+ scale_fill_manual(values = c(uva_color_palette[9], uva_color_palette[6], uva_color_palette[3], uva_color_palette[1], uva_color_palette[5])) +
 theme(legend.position="top")
```

#### Most GitHub users based in the US are around 4 times higher than in China 

<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>

### U.S. States Where Github Users are Located

```{r fig.width=7, fig.height=4, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
state_ttl_user <- city_clean_final%>%
  filter(!is.na(c_us_state))%>%
  group_by(c_us_state)%>%
  summarize(ttl_users = n())%>%
  mutate(c_us_state = tools::toTitleCase(c_us_state))

quantile <- quantile(state_ttl_user$ttl_users, probs = seq(0, 1, 0.2), na.rm = FALSE, names = TRUE, type = 7)

state_ttl_user <- state_ttl_user%>%
  mutate(ttl_users_quantile = if_else(ttl_users < quantile[2], "[56, 399)",
                              if_else(ttl_users < quantile[3], "[399, 728)",
                              if_else(ttl_users < quantile[4], "[728, 1961)",
                              if_else(ttl_users < quantile[5], "[1961, 3885)", "[3885, 40379)")))))

#table(state_ttl_user$ttl_users_quantile)

state_ttl_user$ttl_users_quantile <- factor(state_ttl_user$ttl_users_quantile, levels = c("[56, 399)", "[399, 728)","[728, 1961)","[1961, 3885)", "[3885, 40379)" ))

statebins(state_ttl_user,
         # plot_title = "U.S. States Where Github Users are Located",
          state_col = "c_us_state",
          value_col = "ttl_users_quantile",
          name = "Total Number of Users \n by Quantile Groups",
          ggplot2_scale_function = scale_fill_manual,
          values = c("[56, 399)" = "#f9f9f9" , "[399, 728)" = "#60999A","[728, 1961)" = "#0E879C","[1961, 3885)" = "#1D6B84", "[3885, 40379)" = "#232D4B",
          font_size=10,
          state_border_size =1))+
  theme_statebins(legend_position = "right",  base_size = 11)+
theme(plot.margin = margin(1,1,1,1))
```

#### Within the US, most GitHub users are based on the coasts and near major tech hubs 

<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>

### Cities Where Github Users are Located

```{r fig.width=10, fig.height=6, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
gh_city <- city_clean_final_aggregate%>%
  arrange(-ttl_users)%>%
 # top_n(10, ttl_users)%>%  #don't know why this code doesn't work
  filter(ttl_users >= 6651) %>%
  mutate(city_country = if_else(city_country == "London, United Kingdom", "London, UK", 
                                if_else(city_country == "San Francisco, US", "San, Francisco, US",
                                city_country)))

#table(gh_city$city_country)
gh_city$city_country <- str_replace_all(gh_city$city_country, fixed(","), "\n") 
#table(gh_city$city_country)

gh_city$city_country <- factor(gh_city$city_country, levels = gh_city$city_country[order(gh_city$ttl_users)])
# NOTE ::: Could you please shorten the labels for the USA and Russia cities 


gh_city$Continent <- c("North America", "Europe", "North America", "Europe", "Asia", "North America", "Asia", "Europe", "Asia", "Asia")

min = min(gh_city$ttl_users)
max = max(gh_city$ttl_users)

ggplot(gh_city, aes(x = city_country, y = ttl_users, fill=Continent))+
  geom_bar(stat = "identity") +
  labs(#title = "Countries where Github users are located", 
       x = "City", y = "Total Number of Users")+
  theme_bw()+
  scale_y_continuous(breaks=c(0,2000, 4000, 6000, 8000, 10000,12000, 14000,max), 
    labels = c("0", "2000", "4000", "6000","8000", "10000",  "12000", "14000",as.character(max)))+
  theme(legend.spacing.y = unit(1,"cm"))+
  theme(axis.text.x = element_text(size = 13, hjust = .5, vjust = .5),
        axis.text.y = element_text(size = 12, hjust = .5, vjust = .5),  
        axis.title.x = element_text(size = 14, hjust = .5, vjust = .5),
        axis.title.y = element_text(size = 14, hjust = .5, vjust = .5),
        legend.text = element_text(size = 11),
        legend.title = element_text(size=13))+ 
  scale_fill_manual(values = c( uva_color_palette[6], uva_color_palette[3],uva_color_palette[9]))+
 theme(legend.position="top")
```

#### Silicon Valley is the world's most prominent OSS hotspot <br/> followed by London, NYC, Moscow and Beijing

<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
#In this map, the color of the circle indicates the number of github users in each city, still under development.
city_clean_final_aggregate_top <- city_clean_final_aggregate%>%
  filter(ttl_users > 10)%>%
  mutate(ttl_users_t = log(ttl_users), perc = ttl_users_t/max(ttl_users_t))

pal <- colorFactor(
  palette = c(uva_color_palette[2], uva_color_palette[9]),
  levels = c( "not topcity", "topcity")
)

#ttl user indicated by size
city_clean_final_aggregate%>%
#  mutate(ttl_users_exp = exp(ttl_users)^(1/3))%>%
  leaflet()%>%
  addTiles()%>%
  addSearchOSM()%>%
  addReverseSearchOSM()%>%
  clearMarkers()%>%
  addResetMapButton()%>%
  addCircleMarkers(
    lng = ~long , 
    lat = ~lat, 
    label = ~ paste(city_country,", ", ttl_users, " user(s)", sep = ""),
    radius = ~ttl_users^(1/3), 
    color  = ~pal(top_city))%>% 
  addLegend(pal = pal, values = c( "not topcity", "topcity"))
```

<!-- [![GitHub Users Around the World](https://res.cloudinary.com/marcomontalbano/image/upload/v1596230317/video_to_markdown/images/youtube--KHokyhsd6IM-c05b58ac6eb4c4700831b2b3070cd403.jpg)](https://www.youtube.com/watch?v=KHokyhsd6IM "GitHub Users Around the World") -->

<!-- #### Click to see a video or visit our [interactive map](/findings/geographic/) of GitHub users around the world -->

<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>

### City-Level GitHub Users Collaboration Network
<center>
**Node size**: Weighted degree, reflects the amount of direct collaboration 
</center>


<center>
![](/findings/sectoring-oss_files/14_all_cities_by_continent_degree.png){width=70%}
</center>

<center>
**Node size**: Betweenness centrality, reflects importance in the global network   
</center>

<center>
![](/findings/geographic_files/14_legend.png){width=95%}


<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>


## Main Findings

#### The majority of users come from the business sector followed <br/> by the academic, government and household sectors

<br>

#### Most OSS production seems to be coming from the business sector 

<br>

#### Most GitHub users are based in the US (both in general and in the academic sector)

<br>

#### Major universities in California may also be benefitting <br/> from the proximity of Silicon Valley's OSS production 

<br>

## Challenges & Future Directions

#### Hoping to scrape more user data to improve classification accurary

<br>

#### Improving the government, non-profit and household classification systems 

<br>

#### Determine how to classify contributions at the intersection of multiple sectors 

<br>

#### Conducting network analysis within and across sectors to understand collaboration tendencies

<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
